<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>K MART AL RAFFA - Smart Master</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f8fafc">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000000">
  <link rel="apple-touch-icon" href="icon-192.jpeg">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');
    
    body { 
      -webkit-user-select: none; 
      user-select: none; 
      -webkit-tap-highlight-color: transparent; 
      font-family: 'Inter', sans-serif;
    }

    .glass-effect {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.4);
    }

    @media (prefers-color-scheme: dark) {
      .glass-effect {
        background: rgba(18, 18, 18, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.05);
      }
    }

    /* Modal Animation */
    #item-modal {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      opacity: 0;
      pointer-events: none;
      transform: scale(0.95);
    }
    #item-modal.active {
      opacity: 1;
      pointer-events: auto;
      transform: scale(1);
    }

    /* Laser Scanner Animation */
    .scan-line {
      width: 100%; height: 3px; background: #3b82f6;
      position: absolute; top: 0; box-shadow: 0 0 15px #3b82f6;
      animation: scanMove 2.5s infinite linear;
      z-index: 10;
    }
    @keyframes scanMove { 0%, 100% { top: 5%; } 50% { top: 95%; } }

    .item-card-anim { animation: fadeInUp 0.5s ease-out forwards; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>

<body class="bg-slate-50 dark:bg-black min-h-screen pb-20 transition-colors duration-500">

  <div class="max-w-xl mx-auto p-4 space-y-6">

    <header class="flex items-center justify-between glass-effect p-4 rounded-[2.5rem] shadow-sm">
      <div class="flex items-center gap-3">
        <img src="icon-192.jpeg" id="app-logo" class="w-12 h-12 rounded-2xl shadow-lg" alt="Logo">
        <div>
          <h1 class="text-xl font-black tracking-tighter dark:text-white uppercase leading-none">K Mart</h1>
          <p class="text-[9px] font-bold text-blue-500 uppercase tracking-widest mt-1">Al Raffa Smart Master</p>
        </div>
      </div>
      <div class="text-right">
        <div id="status-badge" class="flex items-center gap-2 bg-slate-100 dark:bg-neutral-800 px-3 py-1 rounded-full border border-slate-200 dark:border-neutral-700">
          <span id="status-dot" class="w-2 h-2 rounded-full bg-orange-500 animate-pulse"></span>
          <span id="status-text" class="text-[9px] font-black text-slate-500 uppercase">Syncing</span>
        </div>
      </div>
    </header>

    <div id="config-panel" class="hidden">
      <input id="sheet-id" type="text" value="1eEFtb7wxOOLw-TFTf_NvSFq1VQy1qYlMoVmiZkFgUys" />
      <input id="gid-id" type="text" value="710656272" />
    </div>

    <section id="camera-section" class="hidden item-card-anim">
      <div class="relative w-full h-60 bg-black rounded-[2.5rem] overflow-hidden shadow-2xl">
        <div id="reader"></div>
        <div class="scan-line"></div>
        <button onclick="stopCamera()" class="absolute top-4 right-4 bg-white/10 backdrop-blur-md p-3 rounded-full text-white z-20 hover:bg-red-500">
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </div>
    </section>

    <section class="glass-effect p-2 rounded-[3rem] shadow-2xl shadow-blue-500/5 transition-all">
      <div class="relative flex items-center">
        <button onclick="startVoiceSearch()" id="mic-btn" class="ml-2 p-4 text-slate-400 hover:text-blue-500 transition-all active:scale-90">
          <i data-lucide="mic" class="w-7 h-7"></i>
        </button>
        <input id="smart-search" type="text" placeholder="Barcode or Name..."
          class="w-full py-6 px-4 bg-transparent text-xl font-bold dark:text-white placeholder:text-slate-300 dark:placeholder:neutral-800 focus:outline-none"
          oninput="handleSearch()" />
        <button onclick="toggleCamera()" class="mr-2 bg-slate-900 dark:bg-blue-600 text-white p-5 rounded-[2.2rem] shadow-xl hover:scale-105 active:scale-95 transition-all">
          <i data-lucide="scan" class="w-7 h-7"></i>
        </button>
      </div>
    </section>

    <div id="results-area" class="hidden space-y-4 item-card-anim">
        <div class="bg-gradient-to-br from-blue-700 to-indigo-900 rounded-[2.5rem] p-8 text-white shadow-2xl shadow-blue-900/20">
            <div class="flex justify-between items-start">
                <span class="bg-white/20 px-3 py-1 rounded-full text-[9px] font-black uppercase tracking-widest border border-white/10">Primary Item</span>
                <i data-lucide="package-check" class="w-6 h-6 opacity-40"></i>
            </div>
            <h2 id="main-title" class="text-3xl font-black mt-4 leading-tight tracking-tighter"></h2>
            
            <div class="grid grid-cols-2 gap-4 mt-8">
                <div onclick="openItemPopup(0)" class="bg-white/10 p-4 rounded-3xl border border-white/10 active:scale-95 transition-all cursor-pointer">
                    <p class="text-[8px] font-black opacity-60 uppercase">Base Barcode</p>
                    <p id="main-barcode" class="font-mono font-bold text-sm"></p>
                </div>
                <div class="bg-white/10 p-4 rounded-3xl border border-white/10">
                    <p class="text-[8px] font-black opacity-60 uppercase">Price</p>
                    <p id="main-price" class="text-xl font-black"></p>
                </div>
            </div>
        </div>

        <div class="space-y-3">
            <h3 class="text-[10px] font-black text-slate-400 dark:text-neutral-500 uppercase tracking-[0.3em] px-4">Available CF Variations</h3>
            <div id="variation-grid" class="space-y-3">
                </div>
        </div>
    </div>

    <div id="no-result" class="hidden text-center py-20">
        <div class="bg-slate-100 dark:bg-neutral-900 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-4">
            <i data-lucide="search-x" class="text-slate-300 w-10 h-10"></i>
        </div>
        <p class="text-slate-500 font-bold uppercase text-xs tracking-widest">No Item Found</p>
    </div>

    <div id="item-modal" class="fixed inset-0 z-[100] flex items-end sm:items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-neutral-900 w-full max-w-lg rounded-[2.5rem] overflow-hidden shadow-2xl border border-slate-100 dark:border-neutral-800">
            <div class="p-6 border-b border-slate-50 dark:border-neutral-800 flex justify-between items-center">
                <div>
                    <h3 id="modal-item-name" class="text-xl font-black text-slate-900 dark:text-white"></h3>
                    <p id="modal-cf-tag" class="text-[10px] font-black text-blue-500 uppercase tracking-widest"></p>
                </div>
                <button onclick="closeModal()" class="p-2 bg-slate-50 dark:bg-neutral-800 rounded-full text-slate-400">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div id="modal-data-list" class="p-6 max-h-[60vh] overflow-y-auto divide-y divide-slate-50 dark:divide-neutral-800">
                </div>

            <div class="p-6 bg-slate-50 dark:bg-neutral-800/50 flex gap-3">
                <button id="modal-share-btn" class="flex-grow bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-2xl font-black text-sm flex items-center justify-center gap-2 shadow-lg transition-all active:scale-95">
                    <i data-lucide="share-2" class="w-4 h-4"></i> SHARE INFO
                </button>
            </div>
        </div>
    </div>

  </div>

  <script>
    let _DB = [];
    let _HEADERS = [];
    let _SCANNER = null;
    let _LAST_RESULTS = [];

    lucide.createIcons();

    window.onload = () => {
        fetchInventory();
        // Theme Check
        const darkTheme = window.matchMedia('(prefers-color-scheme: dark)');
        const logoSet = (isDark) => document.getElementById('app-logo').src = isDark ? 'icon-dark-512.png' : 'icon-512.png';
        logoSet(darkTheme.matches);
        darkTheme.addEventListener('change', e => logoSet(e.matches));
    };

    async function fetchInventory() {
        const sid = document.getElementById("sheet-id").value;
        const gid = document.getElementById("gid-id").value;
        const dot = document.getElementById("status-dot");
        const txt = document.getElementById("status-text");

        try {
            const res = await fetch(`https://docs.google.com/spreadsheets/d/${sid}/export?format=csv&gid=${gid}`);
            const data = await res.text();
            _DB = parseCSV(data);
            _HEADERS = Object.keys(_DB[0]);

            txt.innerText = "Online â€¢ " + _DB.length;
            dot.className = "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_#22c55e]";
        } catch (e) {
            txt.innerText = "Offline Mode";
            dot.className = "w-2 h-2 rounded-full bg-red-500";
        }
    }

    function handleSearch() {
        const query = document.getElementById("smart-search").value.trim().toLowerCase();
        const area = document.getElementById("results-area");
        const empty = document.getElementById("no-result");

        area.classList.add("hidden");
        empty.classList.add("hidden");

        if (query.length < 2) return;

        // Search logic
        let matches = _DB.filter(r => String(Object.values(r)[0]).toLowerCase() === query);
        if (matches.length === 0) {
            const tokens = query.split(/\s+/);
            matches = _DB.filter(r => {
                const name = String(Object.values(r)[1]).toLowerCase();
                return tokens.every(t => name.includes(t));
            });
        }

        if (matches.length > 0) {
            // Group by name for CF logic
            const targetName = Object.values(matches[0])[1];
            _LAST_RESULTS = _DB.filter(r => Object.values(r)[1] === targetName);
            
            // Sort: CF 1 should be first
            _LAST_RESULTS.sort((a, b) => {
                const cfA = parseFloat(a['CF'] || a['cf'] || 0);
                const cfB = parseFloat(b['CF'] || b['cf'] || 0);
                return (cfA === 1) ? -1 : (cfB === 1 ? 1 : cfA - cfB);
            });

            renderUI(_LAST_RESULTS);
        } else {
            empty.classList.remove("hidden");
        }
    }

    function renderUI(items) {
        document.getElementById("results-area").classList.remove("hidden");
        const main = items[0];
        
        document.getElementById("main-title").innerText = Object.values(main)[1];
        document.getElementById("main-barcode").innerText = Object.values(main)[0];
        document.getElementById("main-price").innerText = "AED " + (main['Price'] || main['PRICE'] || main['mrp'] || '0.00');

        const grid = document.getElementById("variation-grid");
        grid.innerHTML = "";

        items.forEach((v, idx) => {
            const cf = v['CF'] || v['cf'] || '1';
            const barcode = Object.values(v)[0];
            const price = v['Price'] || v['PRICE'] || v['mrp'] || '0.00';

            const card = document.createElement("div");
            card.className = `flex items-center justify-between p-5 rounded-[2rem] border transition-all active:scale-[0.98] cursor-pointer ${idx === 0 ? 'bg-blue-50 border-blue-200 dark:bg-blue-900/20 dark:border-blue-800 shadow-xl shadow-blue-500/10' : 'bg-white dark:bg-neutral-900 border-slate-100 dark:border-neutral-800'}`;
            card.onclick = () => openItemPopup(idx);
            
            card.innerHTML = `
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-2xl bg-white dark:bg-neutral-800 border border-slate-100 dark:border-neutral-700 flex flex-col items-center justify-center font-black text-xs text-blue-600">
                        <span class="text-[7px] text-slate-400 leading-none">CF</span>${cf}
                    </div>
                    <div>
                        <p class="text-xs font-mono font-bold text-slate-400">${barcode}</p>
                        <p class="text-[9px] font-black uppercase tracking-widest text-slate-300">Barcode ID</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-lg font-black dark:text-white leading-none">AED ${price}</p>
                </div>
            `;
            grid.appendChild(card);
        });
        lucide.createIcons();
    }

    /**
     * MODAL FUNCTIONS
     */
    function openItemPopup(index) {
        const item = _LAST_RESULTS[index];
        const modal = document.getElementById("item-modal");
        const list = document.getElementById("modal-data-list");
        
        document.getElementById("modal-item-name").innerText = Object.values(item)[1];
        document.getElementById("modal-cf-tag").innerText = "Conversion Factor (CF): " + (item['CF'] || item['cf'] || '1');

        list.innerHTML = "";
        _HEADERS.forEach(h => {
            list.innerHTML += `
                <div class="py-4 flex justify-between items-start gap-4">
                    <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest mt-1">${h}</span>
                    <span class="text-sm font-bold text-slate-700 dark:text-neutral-300 text-right">${item[h] || '-'}</span>
                </div>
            `;
        });

        document.getElementById("modal-share-btn").onclick = () => shareItem(item);

        modal.classList.add("active");
        if (navigator.vibrate) navigator.vibrate(50);
    }

    function closeModal() {
        document.getElementById("item-modal").classList.remove("active");
    }

    function shareItem(item) {
        const text = `ðŸ›’ *K MART AL RAFFA*\n\n*Product:* ${Object.values(item)[1]}\n*Barcode:* ${Object.values(item)[0]}\n*Price:* AED ${item['Price'] || item['mrp'] || '0.00'}\n*Unit (CF):* ${item['CF'] || '1'}\n\n_Generated via Smart Master_`;
        if (navigator.share) {
            navigator.share({ title: 'Product Info', text: text });
        } else {
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`);
        }
    }

    /**
     * CAMERA & SCANNER
     */
    function toggleCamera() {
        const sec = document.getElementById("camera-section");
        if (!sec.classList.contains("hidden")) stopCamera();
        else startCamera();
    }

    function startCamera() {
        document.getElementById("camera-section").classList.remove("hidden");
        _SCANNER = new Html5Qrcode("reader");
        _SCANNER.start({ facingMode: "environment" }, { fps: 30, qrbox: { width: 250, height: 120 } }, 
        (txt) => {
            document.getElementById("smart-search").value = txt;
            stopCamera();
            handleSearch();
            if (navigator.vibrate) navigator.vibrate(100);
        }, () => {});
    }

    function stopCamera() {
        if (_SCANNER) {
            _SCANNER.stop().then(() => { _SCANNER.clear(); _SCANNER = null; });
        }
        document.getElementById("camera-section").classList.add("hidden");
    }

    function startVoiceSearch() {
        const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!Speech) return alert("Browser not supported");
        
        const rec = new Speech();
        const btn = document.getElementById("mic-btn");
        rec.onstart = () => btn.classList.add("text-blue-500", "scale-125");
        rec.onresult = (e) => {
            const txt = e.results[0][0].transcript;
            document.getElementById("smart-search").value = txt;
            handleSearch();
        };
        rec.onend = () => btn.classList.remove("text-blue-500", "scale-125");
        rec.start();
    }

    function parseCSV(text) {
        const lines = text.split(/\r?\n/);
        const head = splitCSVLine(lines[0]);
        return lines.slice(1).filter(l => l.trim()).map(line => {
            const vals = splitCSVLine(line);
            let obj = {};
            head.forEach((h, i) => obj[h.trim()] = vals[i] ? vals[i].trim() : "");
            return obj;
        });
    }

    function splitCSVLine(line) {
        const res = []; let curr = ""; let inside = false;
        for (let char of line) {
            if (char === '"') inside = !inside;
            else if (char === ',' && !inside) { res.push(curr); curr = ""; }
            else curr += char;
        }
        res.push(curr); return res;
    }
  </script>
</body>
</html>
