<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>K MART AL RAFFA - Smart Item Master</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f8fafc">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000000">
  <link rel="apple-touch-icon" href="icon-192.jpeg">
  <link rel="icon" type="image/png" href="icon-512.png">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
    
    :root {
      --primary-blue: #2563eb;
      --glass-bg: rgba(255, 255, 255, 0.85);
      --glass-dark: rgba(23, 23, 23, 0.85);
    }

    body { 
      -webkit-user-select: none; 
      user-select: none; 
      -webkit-tap-highlight-color: transparent; 
      font-family: 'Inter', sans-serif;
      overflow-x: hidden;
    }

    /* Modern Glassmorphism Container */
    .glass-box {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.5);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @media (prefers-color-scheme: dark) {
      .glass-box {
        background: var(--glass-dark);
        border: 1px solid rgba(255, 255, 255, 0.05);
      }
    }

    /* Custom Input States */
    .search-focus:focus-within {
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
      border-color: var(--primary-blue);
    }

    /* Scanner Viewport with Overlay */
    #reader-container {
      position: relative; 
      width: 100%; 
      height: 250px; 
      overflow: hidden;
      border-radius: 3rem; 
      background: #000;
      box-shadow: 0 25px 60px -15px rgba(0, 0, 0, 0.6);
    }
    
    #reader video { 
      width: 100% !important; 
      height: 250px !important; 
      object-fit: cover !important; 
    }

    /* Floating Scan Animation */
    .scan-guide {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      width: 70%; height: 120px;
      border: 2px solid rgba(59, 130, 246, 0.5);
      border-radius: 20px;
      box-shadow: 0 0 0 1000px rgba(0,0,0,0.5);
      z-index: 5;
    }

    .laser {
      width: 100%; 
      height: 4px; 
      background: linear-gradient(to bottom, transparent, #3b82f6, transparent);
      position: absolute; 
      top: 0;
      box-shadow: 0 0 20px #3b82f6;
      animation: laserMove 2.5s infinite linear;
    }

    @keyframes laserMove { 
      0%, 100% { top: 0%; opacity: 0.5; } 
      50% { top: 100%; opacity: 1; } 
    }

    /* Smooth Animations */
    .item-card-animate {
      animation: cardEnter 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }

    @keyframes cardEnter {
      from { opacity: 0; transform: translateY(30px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    /* Skeleton Loading Effect */
    .shimmer {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

    /* History Pills */
    .history-pill {
      transition: all 0.2s ease;
      background: white;
    }
    @media (prefers-color-scheme: dark) { .history-pill { background: #171717; } }
    .history-pill:active { transform: scale(0.9); }
  </style>
</head>

<body class="bg-slate-50 dark:bg-black min-h-screen transition-colors duration-500">

  <div class="max-w-2xl mx-auto px-4 pt-6 pb-24 space-y-7">

    <nav class="flex items-center justify-between glass-box p-4 rounded-[2.5rem] shadow-sm">
      <div class="flex items-center gap-4">
        <div class="relative">
          <img src="icon-192.jpeg" id="app-logo" class="w-14 h-14 rounded-2xl shadow-lg border-2 border-white dark:border-neutral-800" alt="K Mart">
          <div class="absolute -top-1 -right-1 w-4 h-4 bg-green-500 border-2 border-white dark:border-neutral-900 rounded-full"></div>
        </div>
        <div>
          <h1 class="text-2xl font-black tracking-tight text-slate-900 dark:text-white leading-none">K MART</h1>
          <p class="text-[10px] font-extrabold text-blue-500 uppercase tracking-widest mt-1">Smart Item Master</p>
        </div>
      </div>
      
      <div class="text-right">
        <div id="status-badge" class="flex items-center gap-2 bg-slate-100 dark:bg-neutral-800 px-3 py-1.5 rounded-full transition-all">
          <span id="status-dot" class="w-2 h-2 rounded-full bg-orange-500 animate-pulse"></span>
          <span id="status-text" class="text-[9px] font-black text-slate-500 dark:text-neutral-400 uppercase tracking-tighter">Connecting</span>
        </div>
        <p id="sync-time" class="text-[8px] font-bold text-slate-400 mt-1 font-mono uppercase"></p>
      </div>
    </nav>

    <div id="app-config" class="hidden">
      <input id="cfg-sheet-id" type="text" value="1eEFtb7wxOOLw-TFTf_NvSFq1VQy1qYlMoVmiZkFgUys" />
      <input id="cfg-gid-id" type="text" value="710656272" />
    </div>

    <section id="camera-section" class="hidden item-card-animate">
      <div id="reader-container">
        <div id="reader"></div>
        <div class="scan-guide"><div class="laser"></div></div>
        <button onclick="uiAction.stopScanner()" class="absolute top-6 right-6 bg-white/20 backdrop-blur-2xl p-3.5 rounded-full text-white z-20 hover:bg-red-500 transition-all">
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </div>
    </section>

    <section class="glass-box p-3 rounded-[3rem] shadow-2xl shadow-blue-500/10 dark:shadow-none transition-all search-focus">
      <div class="relative flex items-center">
        <button id="voice-trigger" onclick="searchCore.initVoice()" class="ml-2 p-4 text-slate-400 hover:text-blue-500 active:scale-90 transition-all">
          <i data-lucide="mic" class="w-7 h-7"></i>
        </button>
        
        <input id="master-search-input" type="text" 
          placeholder="Barcode or Product Name..."
          class="w-full py-6 px-4 bg-transparent text-xl font-bold dark:text-white placeholder:text-slate-300 dark:placeholder:neutral-800 focus:outline-none"
          oninput="searchCore.debounceSearch()" />

        <button id="cam-trigger" onclick="uiAction.toggleScanner()" class="mr-2 bg-slate-900 dark:bg-blue-600 text-white p-5 rounded-[2.2rem] shadow-xl hover:scale-105 active:shadow-blue-500/40 transition-all">
          <i data-lucide="maximize" class="w-7 h-7"></i>
        </button>
      </div>
    </section>

    <section id="history-area" class="px-2 space-y-3">
        <div class="flex justify-between items-center">
            <h3 class="text-[10px] font-black text-slate-400 dark:text-neutral-600 uppercase tracking-[0.2em]">Recent Inquiries</h3>
            <button onclick="historyManager.clear()" class="text-[9px] font-bold text-blue-500 uppercase">Clear All</button>
        </div>
        <div id="history-container" class="flex flex-wrap gap-2.5">
            </div>
    </section>

    <main id="results-display" class="hidden space-y-5 item-card-animate">
      <div class="bg-white dark:bg-neutral-900 rounded-[3rem] shadow-2xl border border-slate-100 dark:border-neutral-800 overflow-hidden">
        
        <div class="relative p-7 bg-gradient-to-br from-slate-900 to-slate-800 dark:from-blue-700 dark:to-indigo-900 text-white overflow-hidden">
          <div class="absolute top-0 right-0 p-8 opacity-10">
              <i data-lucide="package" class="w-32 h-32"></i>
          </div>
          
          <div class="relative z-10 flex justify-between items-start">
            <span class="bg-white/10 backdrop-blur-md px-4 py-1.5 rounded-full text-[10px] font-black uppercase tracking-widest border border-white/10">Base Item (CF 1)</span>
            <button id="master-share" class="p-3 bg-white/10 rounded-2xl hover:bg-white/20 transition-all">
              <i data-lucide="share-2" class="w-5 h-5"></i>
            </button>
          </div>

          <div class="relative z-10 mt-6">
              <h2 id="master-title" class="text-3xl font-black leading-[1.1] tracking-tighter"></h2>
              <div class="flex flex-wrap gap-4 mt-6">
                <div class="bg-white/5 backdrop-blur-sm px-5 py-3 rounded-[1.5rem] border border-white/5">
                    <p class="text-[8px] uppercase font-black opacity-60 mb-1">Stock ID</p>
                    <p id="master-code" class="font-mono font-bold text-sm tracking-widest"></p>
                </div>
                <div class="bg-blue-500/20 backdrop-blur-sm px-5 py-3 rounded-[1.5rem] border border-blue-400/20">
                    <p class="text-[8px] uppercase font-black text-blue-200 mb-1">Standard Price</p>
                    <p id="master-price" class="text-2xl font-black"></p>
                </div>
              </div>
          </div>
        </div>

        <div class="p-7 space-y-5">
            <div class="flex items-center gap-3">
                <div class="h-[1px] bg-slate-100 dark:bg-neutral-800 flex-grow"></div>
                <h3 class="text-[10px] font-black text-slate-400 dark:text-neutral-500 uppercase tracking-[0.3em]">Available Packing</h3>
                <div class="h-[1px] bg-slate-100 dark:bg-neutral-800 flex-grow"></div>
            </div>
            
            <div id="variant-grid" class="space-y-3">
                </div>
        </div>

        <div class="px-7 pb-7">
            <button onclick="uiAction.toggleTechSpecs()" class="w-full py-4 flex items-center justify-center gap-3 bg-slate-50 dark:bg-neutral-800/50 rounded-[1.8rem] text-[10px] font-black uppercase text-slate-400 hover:text-blue-500 transition-all">
                <i data-lucide="database" class="w-4 h-4"></i>
                Technical Master Data
                <i data-lucide="chevron-down" class="w-4 h-4" id="tech-chevron"></i>
            </button>
            <div id="tech-specs" class="hidden mt-4 space-y-1 divide-y divide-slate-50 dark:divide-neutral-800">
                </div>
        </div>

      </div>
    </main>

    <div id="multi-match-container" class="hidden space-y-4 item-card-animate">
        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest px-2">Multiple Results Found</p>
        <div id="multi-match-list" class="bg-white dark:bg-neutral-900 rounded-[2.5rem] shadow-lg border border-slate-100 dark:border-neutral-800 overflow-hidden divide-y divide-slate-50 dark:divide-neutral-800">
            </div>
    </div>

    <div id="empty-state" class="hidden item-card-animate text-center py-20">
        <div class="w-24 h-24 bg-slate-100 dark:bg-neutral-900 rounded-[2.5rem] flex items-center justify-center mx-auto mb-6">
          <i data-lucide="search-x" class="text-slate-300 w-12 h-12"></i>
        </div>
        <h3 class="text-xl font-black text-slate-800 dark:text-neutral-300">Item Not Listed</h3>
        <p class="text-sm text-slate-400 mt-2 px-10">We couldn't find any products matching that barcode or name.</p>
    </div>

    <footer class="pt-8 opacity-40 grayscale pointer-events-none">
      <img src="banner.png" class="w-full rounded-[2.5rem] scale-95" alt="K Mart Footer">
    </footer>

  </div>

  <script>
    /**
     * GLOBAL SYSTEM STATE
     */
    let _DB = [];
    let _HEADERS = [];
    let _SCANNER = null;
    let _DEBOUNCE = null;

    /**
     * CORE UI ACTIONS
     */
    const uiAction = {
        toggleScanner: () => {
            const el = document.getElementById("camera-section");
            if (!el.classList.contains("hidden")) uiAction.stopScanner();
            else uiAction.startScanner();
        },
        startScanner: () => {
            document.getElementById("camera-section").classList.remove("hidden");
            _SCANNER = new Html5Qrcode("reader");
            const config = { fps: 30, qrbox: { width: 250, height: 120 }, aspectRatio: 1.0 };
            
            _SCANNER.start({ facingMode: "environment" }, config, (decodedText) => {
                document.getElementById("master-search-input").value = decodedText;
                uiAction.stopScanner();
                searchCore.execute();
                if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
            }).catch(err => alert("Camera permission denied"));
        },
        stopScanner: () => {
            if (_SCANNER) {
                _SCANNER.stop().then(() => { 
                    _SCANNER.clear(); 
                    _SCANNER = null; 
                    document.getElementById("camera-section").classList.add("hidden");
                });
            }
        },
        toggleTechSpecs: () => {
            const el = document.getElementById("tech-specs");
            const icon = document.getElementById("tech-chevron");
            el.classList.toggle("hidden");
            icon.style.transform = el.classList.contains("hidden") ? "rotate(0deg)" : "rotate(180deg)";
        },
        updateStatus: (type, msg) => {
            const dot = document.getElementById("status-dot");
            const text = document.getElementById("status-text");
            const badge = document.getElementById("status-badge");

            text.innerText = msg;
            if (type === 'success') {
                dot.className = "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e]";
                badge.className = "flex items-center gap-2 bg-green-50 dark:bg-green-900/20 px-3 py-1.5 rounded-full border border-green-100 dark:border-green-800";
            } else if (type === 'error') {
                dot.className = "w-2 h-2 rounded-full bg-red-500";
                badge.className = "flex items-center gap-2 bg-red-50 dark:bg-red-900/20 px-3 py-1.5 rounded-full border border-red-100 dark:border-red-800";
            }
        }
    };

    /**
     * SEARCH ENGINE LOGIC
     */
    const searchCore = {
        debounceSearch: () => {
            clearTimeout(_DEBOUNCE);
            _DEBOUNCE = setTimeout(() => searchCore.execute(), 350);
        },
        execute: () => {
            const query = document.getElementById("master-search-input").value.trim().toLowerCase();
            const resDisplay = document.getElementById("results-display");
            const multiDisplay = document.getElementById("multi-match-container");
            const emptyState = document.getElementById("empty-state");

            // Hide all views
            resDisplay.classList.add("hidden");
            multiDisplay.classList.add("hidden");
            emptyState.classList.add("hidden");

            if (query.length < 2) return;

            // 1. Barcode Exact Match
            let matches = _DB.filter(row => String(Object.values(row)[0]).toLowerCase() === query);

            // 2. Name Partial Match
            if (matches.length === 0) {
                const terms = query.split(/\s+/).filter(t => t);
                matches = _DB.filter(row => {
                    const itemName = String(Object.values(row)[1]).toLowerCase();
                    return terms.every(t => itemName.includes(t));
                });
            }

            if (matches.length === 0) {
                emptyState.classList.remove("hidden");
            } else if (matches.length === 1 || searchCore.isSameProduct(matches)) {
                searchCore.renderGrouped(matches);
            } else {
                searchCore.renderMultiList(matches);
            }
        },
        isSameProduct: (matches) => {
            const firstName = Object.values(matches[0])[1];
            return matches.every(m => Object.values(m)[1] === firstName);
        },
        renderGrouped: (matches) => {
            const productName = Object.values(matches[0])[1];
            // Find ALL versions of this product in whole DB for CF logic
            const allVariants = _DB.filter(row => Object.values(row)[1] === productName);
            
            // Sort: CF 1 on top, then others
            allVariants.sort((a, b) => {
                const cfA = parseFloat(a['CF'] || a['cf'] || 0);
                const cfB = parseFloat(b['CF'] || b['cf'] || 0);
                if (cfA === 1) return -1;
                if (cfB === 1) return 1;
                return cfA - cfB;
            });

            const main = allVariants[0];
            document.getElementById("results-display").classList.remove("hidden");
            document.getElementById("master-title").innerText = productName;
            document.getElementById("master-code").innerText = Object.values(main)[0];
            document.getElementById("master-price").innerText = "AED " + (main['Price'] || main['mrp'] || '0.00');
            
            // Master Share
            document.getElementById("master-share").onclick = () => shareUtils.send(main);

            // Render Variants
            const grid = document.getElementById("variant-grid");
            grid.innerHTML = "";
            allVariants.forEach((v, idx) => {
                const cf = v['CF'] || v['cf'] || '1';
                const price = v['Price'] || v['mrp'] || '0.00';
                const code = Object.values(v)[0];

                const card = document.createElement("div");
                card.className = `flex items-center justify-between p-5 rounded-[2rem] border transition-all ${idx === 0 ? 'bg-blue-50/50 border-blue-100 dark:bg-blue-900/10 dark:border-blue-800' : 'bg-slate-50 dark:bg-neutral-800/40 border-slate-100 dark:border-neutral-800'}`;
                card.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-2xl bg-white dark:bg-neutral-800 flex flex-col items-center justify-center border border-slate-100 dark:border-neutral-700 shadow-sm">
                            <span class="text-[8px] font-black text-slate-400 uppercase leading-none mb-0.5">CF</span>
                            <span class="text-sm font-black text-blue-600">${cf}</span>
                        </div>
                        <div>
                            <p class="text-xs font-mono font-bold text-slate-500 dark:text-neutral-400">${code}</p>
                            <p class="text-[8px] font-black text-slate-300 uppercase tracking-widest mt-0.5">Barcode ID</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="text-right">
                            <p class="text-xl font-black text-slate-900 dark:text-white leading-none">AED ${price}</p>
                        </div>
                        <button onclick="shareUtils.sendByIdx('${_DB.indexOf(v)}')" class="p-3 bg-white dark:bg-neutral-800 rounded-2xl shadow-sm hover:text-green-500 transition-colors">
                            <i data-lucide="share" class="w-4 h-4"></i>
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            });

            // Render Tech Specs
            const specs = document.getElementById("tech-specs");
            specs.innerHTML = "";
            _HEADERS.forEach(h => {
                specs.innerHTML += `
                    <div class="py-3.5 flex justify-between items-center px-2">
                        <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">${h}</span>
                        <span class="text-[11px] font-bold text-slate-700 dark:text-neutral-300">${main[h] || 'N/A'}</span>
                    </div>
                `;
            });

            historyManager.add(productName);
            lucide.createIcons();
        },
        renderMultiList: (items) => {
            const container = document.getElementById("multi-match-container");
            const list = document.getElementById("multi-match-list");
            container.classList.remove("hidden");
            list.innerHTML = "";

            // Show unique products only
            const uniqueItems = Array.from(new Set(items.map(i => Object.values(i)[1])))
                                     .map(name => items.find(i => Object.values(i)[1] === name));

            uniqueItems.forEach(item => {
                const name = Object.values(item)[1];
                const code = Object.values(item)[0];
                const row = document.createElement("button");
                row.className = "w-full p-6 flex justify-between items-center text-left hover:bg-slate-50 dark:hover:bg-neutral-800 transition-all";
                row.innerHTML = `
                    <div>
                        <p class="font-bold text-slate-900 dark:text-white">${name}</p>
                        <p class="text-[10px] font-mono text-slate-400 mt-1 uppercase">${code}</p>
                    </div>
                    <i data-lucide="chevron-right" class="w-5 h-5 text-slate-300"></i>
                `;
                row.onclick = () => {
                    document.getElementById("master-search-input").value = name;
                    searchCore.execute();
                };
                list.appendChild(row);
            });
            lucide.createIcons();
        },
        initVoice: () => {
            const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRec) return alert("Speech Recognition not supported.");
            
            const rec = new SpeechRec();
            const btn = document.getElementById("voice-trigger");
            
            rec.onstart = () => btn.classList.add("text-blue-600", "scale-125");
            rec.onresult = (e) => {
                const text = e.results[0][0].transcript.replace(/[.]/g, '');
                document.getElementById("master-search-input").value = text;
                searchCore.execute();
            };
            rec.onend = () => btn.classList.remove("text-blue-600", "scale-125");
            rec.start();
        }
    };

    /**
     * DATA FETCHING & PARSING
     */
    async function initDatabase() {
        const sid = document.getElementById("cfg-sheet-id").value;
        const gid = document.getElementById("cfg-gid-id").value;
        uiAction.updateStatus('process', 'Syncing Data...');

        try {
            const url = `https://docs.google.com/spreadsheets/d/${sid}/export?format=csv&gid=${gid}`;
            const res = await fetch(url);
            if (!res.ok) throw new Error();
            
            const csvText = await res.text();
            _DB = dataParser.parseCSV(csvText);
            _HEADERS = Object.keys(_DB[0]);

            uiAction.updateStatus('success', `Online â€¢ ${_DB.length} Items`);
            document.getElementById("sync-time").innerText = "Last Sync: " + new Date().toLocaleTimeString();
            
        } catch (err) {
            uiAction.updateStatus('error', 'Connection Error');
        }
    }

    const dataParser = {
        parseCSV: (text) => {
            const lines = text.split(/\r?\n/);
            if (lines.length < 2) return [];
            const headerRow = dataParser.splitLine(lines[0]);
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                const values = dataParser.splitLine(line);
                const obj = {};
                headerRow.forEach((h, idx) => {
                    obj[h.trim()] = values[idx] ? values[idx].trim() : "";
                });
                data.push(obj);
            }
            return data;
        },
        splitLine: (line) => {
            const res = [];
            let curr = "";
            let inQuotes = false;
            for (let char of line) {
                if (char === '"') inQuotes = !inQuotes;
                else if (char === ',' && !inQuotes) { res.push(curr); curr = ""; }
                else curr += char;
            }
            res.push(curr);
            return res;
        }
    };

    /**
     * UTILITIES: SHARE & HISTORY
     */
    const shareUtils = {
        send: (item) => {
            const name = Object.values(item)[1];
            const code = Object.values(item)[0];
            const price = item['Price'] || item['mrp'] || '0.00';
            const cf = item['CF'] || item['cf'] || '1';
            
            const msg = `ðŸ›’ *K MART AL RAFFA*\n\n*Product:* ${name}\n*Barcode:* ${code}\n*Price:* AED ${price}\n*Packing Unit:* ${cf}\n\n_Checked via K-Mart Smart Master_`;
            
            if (navigator.share) {
                navigator.share({ title: 'K-Mart Price Check', text: msg });
            } else {
                window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`);
            }
        },
        sendByIdx: (idx) => shareUtils.send(_DB[idx])
    };

    const historyManager = {
        add: (name) => {
            let hist = JSON.parse(localStorage.getItem('kmart_recent') || '[]');
            hist = [name, ...hist.filter(x => x !== name)].slice(0, 10);
            localStorage.setItem('kmart_recent', JSON.stringify(hist));
            historyManager.render();
        },
        render: () => {
            const hist = JSON.parse(localStorage.getItem('kmart_recent') || '[]');
            const cont = document.getElementById("history-container");
            cont.innerHTML = "";
            hist.forEach(name => {
                const btn = document.createElement("button");
                btn.className = "history-pill px-5 py-2.5 rounded-full text-xs font-bold text-slate-500 dark:text-neutral-400 border border-slate-100 dark:border-neutral-800 shadow-sm";
                btn.innerText = name;
                btn.onclick = () => {
                    document.getElementById("master-search-input").value = name;
                    searchCore.execute();
                };
                cont.appendChild(btn);
            });
        },
        clear: () => {
            localStorage.removeItem('kmart_recent');
            historyManager.render();
        }
    };

    /**
     * INITIALIZATION
     */
    window.onload = () => {
        initDatabase();
        historyManager.render();
        
        // Dynamic Logo Theme
        const themeQuery = window.matchMedia('(prefers-color-scheme: dark)');
        const updateLogo = (isDark) => {
            document.getElementById('app-logo').src = isDark ? 'icon-dark-512.png' : 'icon-512.png';
        };
        updateLogo(themeQuery.matches);
        themeQuery.addEventListener('change', e => updateLogo(e.matches));
    };
  </script>
</body>
</html>
