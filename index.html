<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>K MART AL RAFFA - Item Master</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#9ca3af">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000000">
  <link rel="apple-touch-icon" href="icon-192.jpeg">
  <link rel="icon" type="image/png" href="icon-512.png">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

  <style>
    body { 
      -webkit-user-select: none; 
      user-select: none; 
      -webkit-tap-highlight-color: transparent; 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #f3f4f6; }
    ::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 3px; }

    @media (prefers-color-scheme: dark) {
      ::-webkit-scrollbar-track { background: #000000; }
      ::-webkit-scrollbar-thumb { background: #4b5563; }
    }

    .fade-in { animation: fadeIn 0.3s ease-out forwards; }
    @keyframes fadeIn { 
      from { opacity: 0; transform: translateY(8px); } 
      to { opacity: 1; transform: translateY(0); } 
    }

    #reader-container {
      position: relative; 
      width: 100%; 
      height: 220px; 
      overflow: hidden;
      border-radius: 1.5rem; 
      border: 3px solid #374151;
      background: #000;
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
    }
    
    #reader video { 
      width: 100% !important; 
      height: 220px !important; 
      object-fit: cover !important; 
    }

    .scan-overlay {
      position: absolute; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%, -50%);
      width: 80%; 
      height: 100px;
      border: 2px solid rgba(255, 255, 255, 0.5);
      box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
      border-radius: 16px; 
      z-index: 10;
    }

    .scan-line {
      width: 100%; 
      height: 2px; 
      background: #ef4444;
      position: absolute; 
      top: 0;
      box-shadow: 0 0 15px 2px #ef4444;
      animation: scanMove 2s infinite linear;
    }

    @keyframes scanMove { 
      0% { top: 0; } 50% { top: 100%; } 100% { top: 0; } 
    }
  </style>
</head>

<body class="bg-slate-50 dark:bg-black min-h-screen p-3 md:p-6 pb-24 transition-colors duration-500">

  <div class="max-w-lg mx-auto space-y-5">

    <header class="bg-white dark:bg-neutral-900 p-4 rounded-[2rem] shadow-sm border border-slate-100 dark:border-neutral-800 flex items-center gap-4">
      <div class="p-1 rounded-2xl border-2 border-slate-800 dark:border-neutral-700 bg-slate-50 dark:bg-neutral-800">
        <img src="icon-192.jpeg" id="app-logo" class="w-12 h-12 rounded-xl object-cover" alt="K Mart Logo">
      </div>
      <div>
        <h1 class="font-black text-2xl tracking-tighter text-slate-900 dark:text-white">K MART</h1>
        <p class="text-[10px] font-black text-gray-400 dark:text-neutral-500 uppercase tracking-widest">Al Raffa • Item Master</p>
      </div>
    </header>

    <div id="settings-panel" class="hidden">
      <input id="sheet-id" type="text" value="1eEFtb7wxOOLw-TFTf_NvSFq1VQy1qYlMoVmiZkFgUys" />
      <input id="gid-id" type="text" value="710656272" />
    </div>

    <div class="flex justify-between items-center px-2">
      <div id="status-pill" class="bg-white dark:bg-neutral-900 px-4 py-2 rounded-full border border-slate-200 dark:border-neutral-800 shadow-sm flex items-center gap-2">
        <span id="status-dot" class="w-2.5 h-2.5 rounded-full bg-orange-500 animate-pulse"></span>
        <span id="status-text" class="text-xs font-bold text-slate-600 dark:text-neutral-400">Initializing...</span>
      </div>

      <div id="last-update-container" class="hidden flex flex-col items-end">
        <span class="text-[9px] uppercase font-black text-gray-400 dark:text-neutral-600 leading-none">Last Sync</span>
        <span id="last-update-time" class="text-[11px] font-bold text-slate-500 dark:text-neutral-400 font-mono">--:--</span>
      </div>
    </div>

    <section id="reader-container" class="hidden fade-in">
      <div id="reader"></div>
      <div class="scan-overlay"><div class="scan-line"></div></div>
      <button onclick="stopCamera()" class="absolute top-4 right-4 bg-black/60 p-2.5 rounded-full text-white hover:bg-red-600 transition-colors z-20">
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>
    </section>

    <main class="bg-white dark:bg-neutral-900 p-6 rounded-[2.5rem] shadow-sm border border-slate-100 dark:border-neutral-800 space-y-7">
      <div class="space-y-3">
        <label class="block text-[11px] font-black text-slate-400 dark:text-neutral-500 uppercase tracking-widest ml-1">Barcode Scanner</label>
        <div class="flex gap-3">
          <div class="relative flex-grow">
            <i data-lucide="scan-barcode" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 w-6 h-6"></i>
            <input id="id-search-input" type="text" inputmode="numeric" placeholder="Tap camera ->"
              class="w-full pl-12 pr-4 py-4.5 text-xl border-2 border-slate-50 dark:border-neutral-800 bg-slate-50/50 dark:bg-neutral-950 dark:text-white rounded-2xl focus:border-slate-300 font-mono"
              oninput="handleSearch()" />
          </div>
          <button onclick="toggleCamera()" class="bg-slate-900 dark:bg-neutral-800 text-white px-6 rounded-2xl active:scale-95 transition-all">
            <i data-lucide="camera" class="w-7 h-7"></i>
          </button>
        </div>
      </div>

      <div class="relative flex justify-center items-center py-1">
        <div class="absolute inset-0 border-t border-slate-100 dark:border-neutral-800"></div>
        <span class="relative bg-white dark:bg-neutral-900 px-5 text-[9px] font-black text-slate-300 dark:text-neutral-600 uppercase tracking-widest">Manual Search</span>
      </div>

      <div class="relative">
        <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 w-5 h-5"></i>
        <input id="name-search-input" type="text" placeholder="Type product name..."
          class="w-full pl-12 pr-4 py-4.5 text-lg border-2 border-slate-50 dark:border-neutral-800 bg-slate-50/50 dark:bg-neutral-950 dark:text-white rounded-2xl focus:border-slate-300"
          oninput="handleSearch()" />
      </div>
    </main>

    <div id="result-container" class="hidden space-y-3 fade-in">
      <div class="bg-white dark:bg-neutral-900 rounded-[2rem] shadow-xl border border-slate-200 dark:border-neutral-800 overflow-hidden">
        <div class="bg-slate-50/80 dark:bg-black/50 p-6 border-b border-slate-100 dark:border-neutral-800 flex items-center gap-4">
          <div class="bg-green-500 p-2.5 rounded-2xl text-white shadow-lg"><i data-lucide="badge-check" class="w-6 h-6"></i></div>
          <div>
            <p class="text-[10px] font-black text-green-600 uppercase tracking-widest">Verified Result</p>
            <h2 id="result-title" class="text-2xl font-black text-slate-900 dark:text-white leading-tight">Product Name</h2>
          </div>
        </div>
        <div id="result-details" class="p-6 divide-y divide-slate-100 dark:divide-neutral-800"></div>
      </div>
    </div>

    <div id="list-container" class="hidden fade-in">
      <div id="match-list" class="bg-white dark:bg-neutral-900 rounded-[2rem] divide-y divide-slate-50 dark:divide-neutral-800 overflow-hidden border border-slate-100 dark:border-neutral-800"></div>
    </div>

    <div id="no-result" class="hidden fade-in text-center p-12 bg-white dark:bg-neutral-900 rounded-[2rem] border-2 border-dashed border-slate-200 dark:border-neutral-800">
      <i data-lucide="package-search" class="text-slate-300 mx-auto w-10 h-10 mb-4"></i>
      <h3 class="font-bold text-slate-800 dark:text-neutral-200">No Item Found</h3>
    </div>

    <footer>
      <img src="banner.png" class="w-full rounded-3xl opacity-90 object-cover" alt="Banner">
    </footer>

  </div>

  <script>
    let inventory = [];
    let headers = [];
    let html5QrCode = null;

    lucide.createIcons();

    window.onload = function () {
      fetchData();
      if ("serviceWorker" in navigator) { navigator.serviceWorker.register("service-worker.js"); }
    };

    function toggleCamera() {
      const container = document.getElementById("reader-container");
      if (!container.classList.contains("hidden")) { stopCamera(); } else { startCamera(); }
    }

    function startCamera() {
      document.getElementById("reader-container").classList.remove("hidden");
      html5QrCode = new Html5Qrcode("reader");
      const config = { fps: 30, qrbox: { width: 250, height: 120 }, aspectRatio: 1.0 };
      html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure).catch(() => stopCamera());
    }

    function stopCamera() {
      if (html5QrCode) { html5QrCode.stop().then(() => { html5QrCode.clear(); html5QrCode = null; }); }
      document.getElementById("reader-container").classList.add("hidden");
    }

    function onScanSuccess(text) {
      document.getElementById("id-search-input").value = text;
      stopCamera();
      handleSearch();
      if (navigator.vibrate) navigator.vibrate(200);
    }

    function onScanFailure() {}

    async function fetchData() {
      const statusText = document.getElementById("status-text");
      const statusDot = document.getElementById("status-dot");
      const statusPill = document.getElementById("status-pill");

      try {
        const sheetId = document.getElementById("sheet-id").value;
        const gid = document.getElementById("gid-id").value;
        const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;
        
        const response = await fetch(csvUrl);
        const rawText = await response.text();
        const data = parseCSV(rawText);

        inventory = data;
        headers = Object.keys(data[0]);

        // Success UI
        statusText.innerHTML = `Online • ${inventory.length.toLocaleString()} Items`;
        statusText.className = "text-xs font-black text-slate-800 dark:text-gray-200";
        statusDot.className = "w-2.5 h-2.5 rounded-full bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.6)] animate-none";
        statusPill.className = "bg-green-50 dark:bg-green-950/20 px-4 py-2 rounded-full border border-green-200 dark:border-green-900 flex items-center gap-2 transition-all duration-500";

        // TIME STAMP (The requested fix)
        const now = new Date();
        const timeStr = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: true });
        const dateStr = now.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });
        
        document.getElementById("last-update-time").innerText = `${dateStr}, ${timeStr}`;
        document.getElementById("last-update-container").classList.remove("hidden");

      } catch (err) {
        statusText.innerText = "Error Syncing";
        statusDot.className = "w-2.5 h-2.5 rounded-full bg-red-500";
      }
    }

    function handleSearch() {
      const idTerm = document.getElementById("id-search-input").value.trim().toLowerCase();
      const nameTerm = document.getElementById("name-search-input").value.trim().toLowerCase();
      
      const resCon = document.getElementById("result-container");
      const listCon = document.getElementById("list-container");
      const noRes = document.getElementById("no-result");

      resCon.classList.add("hidden"); listCon.classList.add("hidden"); noRes.classList.add("hidden");
      if (!idTerm && !nameTerm) return;

      let results = [];
      if (idTerm) {
        results = inventory.filter(row => String(Object.values(row)[0]).toLowerCase() === idTerm);
      } else if (nameTerm) {
        if (nameTerm.length < 3) return;
        const tokens = nameTerm.split(/\s+/).filter(t => t);
        results = inventory.filter(row => {
          const name = String(Object.values(row)[1]).toLowerCase();
          return tokens.every(t => name.includes(t));
        });
      }

      if (results.length === 1) { renderSingleItem(results[0]); } 
      else if (results.length > 1) { renderItemList(results); } 
      else { noRes.classList.remove("hidden"); }
    }

    function renderSingleItem(match) {
      document.getElementById("result-container").classList.remove("hidden");
      document.getElementById("result-title").innerText = Object.values(match)[1];
      let html = "";
      headers.forEach((h, i) => {
        const v = match[h]; if (!v && v !== 0) return;
        let display = v;
        if (i === 0) display = `<span class="bg-slate-100 dark:bg-neutral-800 px-3 py-1 rounded-lg border border-slate-200 font-mono font-bold">${v}</span>`;
        else if (h.toLowerCase().includes("price") || h.toLowerCase().includes("mrp")) display = `<span class="text-2xl font-black text-slate-900 dark:text-white">${v}</span>`;
        
        html += `<div class="py-4 flex justify-between items-start gap-4">
          <span class="text-[10px] font-black text-slate-400 uppercase pt-1.5">${h}</span>
          <div class="text-right text-base font-bold text-slate-700 dark:text-neutral-300">${display}</div>
        </div>`;
      });
      document.getElementById("result-details").innerHTML = html;
      lucide.createIcons();
    }

    function renderItemList(matches) {
      document.getElementById("list-container").classList.remove("hidden");
      const wrap = document.getElementById("match-list");
      wrap.innerHTML = "";
      matches.forEach(m => {
        const r = document.createElement("div");
        r.className = "p-5 flex justify-between items-center hover:bg-slate-50 dark:hover:bg-neutral-800 transition-colors cursor-pointer group";
        r.innerHTML = `<div><p class="font-bold text-slate-800 dark:text-neutral-200">${Object.values(m)[1]}</p><p class="text-[11px] font-mono text-slate-400">${Object.values(m)[0]}</p></div><i data-lucide="chevron-right" class="w-5 h-5 text-slate-300 group-hover:text-slate-500"></i>`;
        r.onclick = () => renderSingleItem(m);
        wrap.appendChild(r);
      });
      lucide.createIcons();
    }

    function parseCSV(text) {
      const lines = text.split(/\r?\n/); if (lines.length < 2) return [];
      const h = splitCSVLine(lines[0]);
      return lines.slice(1).filter(l => l.trim()).map(line => {
        const v = splitCSVLine(line);
        const obj = {}; h.forEach((head, idx) => obj[head.trim()] = v[idx] ? v[idx].trim() : "");
        return obj;
      });
    }

    function splitCSVLine(l) {
      const p = []; let c = ""; let inQ = false;
      for (let char of l) {
        if (char === '"') inQ = !inQ;
        else if (char === ',' && !inQ) { p.push(c); c = ""; }
        else c += char;
      }
      p.push(c); return p;
    }

    const logo = document.getElementById('app-logo');
    const darkMode = window.matchMedia('(prefers-color-scheme: dark)');
    function setLogo(isDark) { logo.src = isDark ? 'icon-dark-512.png' : 'icon-512.png'; }
    setLogo(darkMode.matches);
    darkMode.addEventListener('change', e => setLogo(e.matches));
  </script>
</body>
</html>
