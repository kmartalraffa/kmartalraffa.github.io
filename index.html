<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>K MART AL RAFFA - Item Master</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#9ca3af">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000000">
  <link rel="apple-touch-icon" href="icon-192.jpeg">
  <link rel="icon" type="image/png" href="icon-512.png">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

  <style>
    body { 
      -webkit-user-select: none; 
      user-select: none; 
      -webkit-tap-highlight-color: transparent; 
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #f3f4f6; }
    ::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 3px; }

    @media (prefers-color-scheme: dark) {
      ::-webkit-scrollbar-track { background: #000000; }
      ::-webkit-scrollbar-thumb { background: #4b5563; }
    }

    .fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { 
      from { opacity: 0; transform: translateY(5px); } 
      to { opacity: 1; transform: translateY(0); } 
    }

    /* Scanner Container */
    #reader-container {
      position: relative; 
      width: 100%; 
      height: 200px; 
      overflow: hidden;
      border-radius: 1rem; 
      border: 3px solid #4b5563; /* gray-600 border */
      background: black;
    }
    #reader { width: 100%; height: 100%; }
    #reader video { 
      width: 100% !important; 
      height: 200px !important; 
      object-fit: cover !important; 
    }

    /* Scanner Overlay */
    .scan-overlay {
      position: absolute; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%, -50%);
      width: 85%; 
      height: 80px;
      border: 2px solid rgba(209, 213, 219, 0.9); /* gray-300 */
      box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.6);
      border-radius: 12px; 
      pointer-events: none; 
      z-index: 10;
    }

    .scan-line {
      width: 100%; 
      height: 3px; 
      background: #d1d5db; /* gray-300 */
      position: absolute; 
      top: 0;
      box-shadow: 0 0 10px #d1d5db;
      animation: scanMove 2s infinite linear;
    }

    @keyframes scanMove { 
      0% { top: 0; } 
      50% { top: 100%; } 
      100% { top: 0; } 
    }
  </style>
</head>
<body class="bg-slate-50 dark:bg-black min-h-screen font-sans text-slate-800 dark:text-gray-300 p-3 md:p-6 pb-20 transition-colors duration-300">
  <div class="max-w-lg mx-auto space-y-4">

    <!-- Header -->
    <div class="bg-white dark:bg-neutral-900 p-4 rounded-3xl shadow-sm border border-slate-100 dark:border-gray-800 flex items-center gap-4">
      <div class="p-1 rounded-2xl border-2 border-gray-700 dark:border-gray-800 shadow-sm">
        <img src="icon-192.jpeg" class="w-12 h-12 rounded-xl object-cover" alt="K Mart Logo">
      </div>
      <div>
        <h1 class="font-black text-2xl text-slate-900 dark:text-gray-200">K MART</h1>
        <p class="text-xs font-bold text-gray-400 dark:text-gray-400 uppercase mt-1">Al Raffa • Item Master</p>
      </div>
    </div>

    <!-- Hidden settings -->
    <div id="settings-panel" class="hidden">
      <input id="sheet-id" type="text" value="1eEFtb7wxOOLw-TFTf_NvSFq1VQy1qYlMoVmiZkFgUys" />
      <input id="gid-id" type="text" value="710656272" />
    </div>

    <!-- Status -->
    <div class="flex justify-between items-center px-2">
      <p id="status-text" class="text-xs font-semibold text-gray-400 dark:text-gray-500 bg-white dark:bg-neutral-900 px-3 py-1.5 rounded-full border border-slate-100 dark:border-gray-800 shadow-sm flex items-center gap-2">
        <span class="w-2 h-2 rounded-full bg-gray-500 animate-pulse"></span> Initializing...
      </p>
    </div>

    <!-- Scanner -->
    <div id="reader-container" class="hidden fade-in shadow-lg">
      <div id="reader"></div>
      <div class="scan-overlay"><div class="scan-line"></div></div>
      <button onclick="stopCamera()" class="absolute top-3 right-3 bg-black/40 p-2 rounded-full text-white hover:bg-black/60 z-20">
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>
    </div>

    <!-- Search Card -->
    <div class="bg-white dark:bg-neutral-900 p-5 md:p-6 rounded-3xl shadow-[0_4px_20px_-10px_rgba(0,0,0,0.8)] border border-slate-100 dark:border-gray-800 space-y-6">

      <!-- Barcode Search -->
      <div>
        <label class="block text-xs font-bold text-gray-400 dark:text-gray-500 uppercase mb-2 ml-1">Barcode Scanner</label>
        <div class="flex gap-2">
          <div class="relative flex-grow">
            <i data-lucide="scan-barcode" class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 dark:text-gray-600 w-6 h-6"></i>
            <input id="id-search-input" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="Tap camera ->"
              class="w-full pl-12 pr-4 py-4 text-xl border-2 border-slate-100 dark:border-gray-800 bg-transparent dark:bg-neutral-900 dark:text-gray-200 rounded-2xl focus:border-gray-400 focus:ring-4 focus:ring-gray-400/10 font-mono placeholder:text-gray-400 dark:placeholder-gray-600"
              oninput="handleSearch()" />
          </div>

          <button id="camera-toggle-btn" onclick="toggleCamera()" class="bg-gray-700 text-white px-5 rounded-2xl hover:bg-gray-600 shadow-lg shadow-gray-700/30">
            <i data-lucide="camera" class="w-7 h-7"></i>
          </button>
        </div>
      </div>

      <!-- Divider -->
      <div class="relative flex justify-center items-center">
        <div class="absolute inset-0 border-t border-slate-100 dark:border-gray-800"></div>
        <span class="relative bg-white dark:bg-neutral-900 px-4 text-[10px] font-bold text-gray-400 dark:text-gray-600 uppercase">OR SEARCH BY NAME</span>
      </div>

      <!-- Name Search -->
      <div class="relative">
        <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 dark:text-gray-600 w-5 h-5"></i>
        <input id="name-search-input" type="text" placeholder="Type product name..."
          class="w-full pl-12 pr-4 py-4 text-lg border-2 border-slate-100 dark:border-gray-800 bg-transparent dark:bg-neutral-900 dark:text-gray-200 rounded-2xl focus:border-gray-400 focus:ring-4 focus:ring-gray-400/10 placeholder:text-gray-400 dark:placeholder-gray-600"
          oninput="handleSearch()" />
      </div>

    </div>

    <!-- Single Result -->
    <div id="result-container" class="hidden space-y-3 fade-in">
      <div class="bg-white dark:bg-neutral-900 rounded-3xl shadow-lg border border-gray-700 dark:border-gray-800 overflow-hidden">

        <div class="bg-slate-50 dark:bg-black p-5 border-b border-slate-100 dark:border-gray-800 flex items-center gap-3">
          <div class="bg-gray-700 p-2 rounded-xl text-white shadow-sm shadow-gray-700/40">
            <i data-lucide="check" class="w-6 h-6"></i>
          </div>
          <div>
            <p class="text-[10px] font-bold text-gray-400 dark:text-gray-400 uppercase">Verified Item</p>
            <h2 id="result-title" class="text-xl font-black text-slate-800 dark:text-gray-200">Product Name</h2>
          </div>
        </div>

        <div id="result-details" class="p-6 divide-y divide-slate-50 dark:divide-gray-800"></div>
      </div>
    </div>

    <!-- Multiple Matches -->
    <div id="list-container" class="hidden space-y-3 fade-in">
      <div id="match-list" class="bg-white dark:bg-neutral-900 rounded-3xl shadow-sm border border-slate-100 dark:border-gray-800 divide-y divide-slate-50 dark:divide-gray-800 overflow-hidden"></div>
    </div>

    <!-- No Result -->
    <div id="no-result" class="hidden space-y-2 fade-in">
      <div class="bg-white dark:bg-neutral-900 p-10 rounded-3xl border-2 border-dashed border-slate-200 dark:border-gray-700 text-center">
        <div class="bg-slate-50 dark:bg-gray-800 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
          <i data-lucide="package-search" class="text-gray-400 dark:text-gray-500 w-8 h-8"></i>
        </div>
        <p class="font-medium text-gray-500 dark:text-gray-400">Item not found in database.</p>
      </div>
    </div>

    <!-- Banner -->
    <div class="pt-4 pb-6">
      <img src="banner.png" class="w-full rounded-2xl shadow-sm border border-slate-100 dark:border-gray-800 object-cover" alt="K Mart Banner">
    </div>

  </div>
<script>
  let inventory = [];
  let headers = [];
  let html5QrCode = null;

  lucide.createIcons();

  window.onload = function () {
    fetchData();

    if ("serviceWorker" in navigator) {
      navigator.serviceWorker
        .register("service-worker.js")
        .then(() => console.log("SW Registered"))
        .catch((err) => console.log("SW Failed", err));
    }
  };

  /* ---------------- CAMERA CONTROL ---------------- */

  function toggleCamera() {
    const readerContainer = document.getElementById("reader-container");

    if (!readerContainer.classList.contains("hidden")) {
      stopCamera();
    } else {
      startCamera();
    }
  }

  function startCamera() {
    document.getElementById("reader-container").classList.remove("hidden");

    const btn = document.getElementById("camera-toggle-btn");
    btn.disabled = true;
    btn.classList.add("opacity-50");

    html5QrCode = new Html5Qrcode("reader");

    const config = {
      fps: 25,
      qrbox: { width: 250, height: 250 },
      aspectRatio: 1.0,
      experimentalFeatures: { useBarCodeDetectorIfSupported: true },
    };

    html5QrCode
      .start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
      .catch((err) => {
        alert("Camera Error: " + err);
        stopCamera();
      });
  }

  function stopCamera() {
    if (html5QrCode) {
      html5QrCode
        .stop()
        .then(() => {
          html5QrCode.clear();
          html5QrCode = null;
        })
        .catch((err) => console.log(err));
    }

    document.getElementById("reader-container").classList.add("hidden");

    const btn = document.getElementById("camera-toggle-btn");
    btn.disabled = false;
    btn.classList.remove("opacity-50");
  }

  function onScanSuccess(decodedText) {
    document.getElementById("id-search-input").value = decodedText;
    stopCamera();
    handleSearch();

    if (navigator.vibrate) navigator.vibrate(200);
  }

  function onScanFailure(error) {
    // ignore continuous scan errors
  }

  /* ---------------- FETCH DATA FROM GOOGLE SHEET ---------------- */

  async function fetchData() {
    const sheetId = document.getElementById("sheet-id").value;
    const gid = document.getElementById("gid-id").value;
    const statusText = document.getElementById("status-text");

    statusText.innerHTML =
      '<span class="w-2 h-2 rounded-full bg-gray-500 animate-pulse"></span> Syncing...';

    try {
      const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;
      const response = await fetch(csvUrl);

      if (!response.ok) throw new Error("Network Error");

      const text = await response.text();

      if (text.includes("<!DOCTYPE html>")) throw new Error("Permission Error");

      const parsedData = parseCSV(text);

      if (parsedData.length === 0) throw new Error("Empty Sheet");

      inventory = parsedData;
      headers = Object.keys(parsedData[0]);

      statusText.innerHTML = `
        <span class="w-2 h-2 rounded-full bg-gray-300"></span> 
        Online • ${inventory.length.toLocaleString()} Items
      `;

      statusText.classList.replace("text-gray-400", "text-gray-300");
      statusText.classList.replace("dark:text-gray-500", "dark:text-gray-300");
      statusText.classList.replace("bg-white", "bg-gray-100");
      statusText.classList.replace("dark:bg-neutral-900", "dark:bg-gray-800/20");
      statusText.classList.replace("border-slate-100", "border-gray-300");
      statusText.classList.replace("dark:border-gray-800", "dark:border-gray-700");
    } catch (err) {
      statusText.innerHTML =
        '<span class="w-2 h-2 rounded-full bg-red-500"></span> Sync Failed';
      statusText.classList.add("text-red-600");
    }
  }

  /* ---------------- DISPLAY SINGLE ITEM ---------------- */

  function displayItemDetails(match) {
    document.getElementById("list-container").classList.add("hidden");
    document.getElementById("no-result").classList.add("hidden");
    document.getElementById("result-container").classList.remove("hidden");

    const productName = Object.values(match)[1];
    document.getElementById("result-title").innerText = productName;

    let html = "";

    headers.forEach((header, index) => {
      const val = match[header];
      if ((!val && val !== 0) || header.toLowerCase() === "image") return;

      let valueDisplay = val;

      if (index === 0) {
        valueDisplay = `
          <span class="font-mono font-bold text-gray-300 bg-gray-800/20 px-2 py-1 rounded-md border border-gray-700">
            ${val}
          </span>`;
      } else if (
        header.toLowerCase().includes("price") ||
        header.toLowerCase().includes("mrp")
      ) {
        valueDisplay = `
          <span class="font-black text-lg text-gray-200">
            ${val}
          </span>`;
      }

      html += `
        <div class="py-3 grid grid-cols-3 gap-4 items-center">
          <span class="text-[11px] font-bold text-gray-500 uppercase">${header}</span>
          <span class="text-base font-medium text-gray-300 col-span-2">${valueDisplay}</span>
        </div>`;
    });

    document.getElementById("result-details").innerHTML = html;
    lucide.createIcons();
  }

  /* ---------------- SEARCH HANDLER ---------------- */

  function handleSearch() {
    const idTerm = document.getElementById("id-search-input").value.trim().toLowerCase();
    const nameTerm = document.getElementById("name-search-input").value.trim().toLowerCase();

    const resultContainer = document.getElementById("result-container");
    const listContainer = document.getElementById("list-container");
    const noResultContainer = document.getElementById("no-result");

    resultContainer.classList.add("hidden");
    listContainer.classList.add("hidden");
    noResultContainer.classList.add("hidden");

    if (!idTerm && !nameTerm) return;

    let matches = [];

    if (idTerm) {
      document.getElementById("name-search-input").value = "";
      matches = inventory.filter(
        (row) => String(Object.values(row)[0]).toLowerCase() === idTerm
      );
    } else if (nameTerm) {
      document.getElementById("id-search-input").value = "";
      if (nameTerm.length < 3) return;

      const tokens = nameTerm.split(/\s+/).filter((t) => t);

      matches = inventory.filter((row) => {
        const prodName = String(Object.values(row)[1]).toLowerCase();
        return tokens.every((token) => prodName.includes(token));
      });
    }

    if (matches.length === 1) {
      displayItemDetails(matches[0]);
    } else if (matches.length > 1) {
      listContainer.classList.remove("hidden");

      const matchList = document.getElementById("match-list");
      matchList.innerHTML = "";

      matches.forEach((match) => {
        const div = document.createElement("div");
        div.className =
          "p-4 flex justify-between items-center hover:bg-gray-800/20 cursor-pointer group";

        div.innerHTML = `
          <div>
            <p class="font-bold text-gray-200 group-hover:text-gray-300">${Object.values(match)[1]}</p>
            <p class="text-xs font-mono text-gray-500">${Object.values(match)[0]}</p>
          </div>
          <i data-lucide='chevron-right' class='w-5 h-5 text-gray-500 group-hover:text-gray-300'></i>
        `;

        div.onclick = () => displayItemDetails(match);
        matchList.appendChild(div);
      });

      lucide.createIcons();
    } else {
      noResultContainer.classList.remove("hidden");
    }
  }
</script>
<script>
  /* ---------------- CSV PARSER (FIXED + CLEAN) ---------------- */

  function parseCSV(text) {
    const lines = text.split(/\r?\n/);
    if (lines.length < 2) return [];

    const headers = splitCSVLine(lines[0]);
    const result = [];

    for (let i = 1; i < lines.length; i++) {
      const line = lines[i].trim();
      if (!line) continue;

      const values = splitCSVLine(line);
      const entry = {};

      headers.forEach((h, idx) => {
        entry[h.trim()] = values[idx] ? values[idx].trim() : "";
      });

      result.push(entry);
    }

    return result;
  }

  function splitCSVLine(line) {
    const values = [];
    let current = "";
    let inQuotes = false;

    for (let i = 0; i < line.length; i++) {
      const char = line[i];

      if (char === '"') {
        inQuotes = !inQuotes;
      } else if (char === "," && !inQuotes) {
        values.push(current);
        current = "";
      } else {
        current += char;
      }
    }

    values.push(current);
    return values;
  }
</script>

</body>
</html>
