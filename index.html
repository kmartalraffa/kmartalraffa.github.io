<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>K MART AL RAFFA - Smart Item Master</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f8fafc">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000000">
  <link rel="apple-touch-icon" href="icon-192.jpeg">
  <link rel="icon" type="image/png" href="icon-512.png">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');
    
    body { 
      -webkit-user-select: none; 
      user-select: none; 
      -webkit-tap-highlight-color: transparent; 
      font-family: 'Inter', sans-serif;
    }

    /* Glassmorphism Design */
    .glass-effect {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 255, 255, 0.4);
    }

    @media (prefers-color-scheme: dark) {
      .glass-effect {
        background: rgba(18, 18, 18, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.05);
      }
    }

    /* Animated Scanner */
    #reader-container {
      position: relative; width: 100%; height: 240px; overflow: hidden;
      border-radius: 2.5rem; background: #000;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }
    
    #reader video { width: 100% !important; height: 240px !important; object-fit: cover !important; }

    .scan-line {
      width: 100%; height: 4px; background: #3b82f6;
      position: absolute; top: 0; box-shadow: 0 0 20px #3b82f6;
      animation: scanMove 2.5s infinite ease-in-out;
      z-index: 10;
    }

    @keyframes scanMove { 0%, 100% { top: 5%; } 50% { top: 90%; } }

    .fade-in { animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    .pulse-blue { animation: pulse 2s infinite; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
  </style>
</head>

<body class="bg-slate-50 dark:bg-black min-h-screen pb-20 transition-colors duration-500">

  <div class="max-w-xl mx-auto p-4 space-y-6">

    <header class="flex items-center justify-between bg-white dark:bg-neutral-900/50 p-4 rounded-[2rem] shadow-sm border border-slate-100 dark:border-neutral-800">
      <div class="flex items-center gap-3">
        <img src="icon-192.jpeg" id="app-logo" class="w-12 h-12 rounded-2xl shadow-md border border-slate-100 dark:border-neutral-800" alt="Logo">
        <div>
          <h1 class="text-xl font-black tracking-tighter dark:text-white uppercase">K Mart</h1>
          <p class="text-[9px] font-bold text-blue-500 uppercase tracking-[0.2em]">Smart Master v2.0</p>
        </div>
      </div>
      <div class="flex flex-col items-end">
        <div id="status-pill" class="flex items-center gap-2 bg-slate-50 dark:bg-neutral-800 px-3 py-1 rounded-full border border-slate-100 dark:border-neutral-700">
          <span id="status-dot" class="w-2 h-2 rounded-full bg-orange-500"></span>
          <span id="status-text" class="text-[10px] font-bold text-slate-500 uppercase">Syncing</span>
        </div>
        <span id="last-update-time" class="text-[9px] font-mono text-slate-400 mt-1"></span>
      </div>
    </header>

    <div id="settings-panel" class="hidden">
      <input id="sheet-id" type="text" value="1eEFtb7wxOOLw-TFTf_NvSFq1VQy1qYlMoVmiZkFgUys" />
      <input id="gid-id" type="text" value="710656272" />
    </div>

    <section id="reader-container" class="hidden fade-in">
      <div id="reader"></div>
      <div class="absolute inset-0 border-[60px] border-black/40 pointer-events-none"></div>
      <div class="scan-line"></div>
      <button onclick="stopCamera()" class="absolute top-6 right-6 bg-white/10 backdrop-blur-xl p-3 rounded-full text-white z-20 hover:bg-red-500 transition-all">
        <i data-lucide="x" class="w-6 h-6"></i>
      </button>
    </section>

    <section class="glass-effect p-2 rounded-[2.8rem] shadow-2xl shadow-blue-500/5 dark:shadow-none transition-all">
      <div class="relative flex items-center">
        <button id="voice-btn" onclick="startVoiceSearch()" class="ml-2 p-4 text-slate-400 hover:text-blue-500 transition-colors">
          <i data-lucide="mic" class="w-7 h-7"></i>
        </button>
        
        <input id="smart-search-input" type="text" placeholder="Scan barcode or type item name..."
          class="w-full py-6 px-4 bg-transparent text-lg font-bold dark:text-white placeholder:text-slate-300 dark:placeholder:neutral-700 focus:outline-none"
          oninput="handleSearch()" />

        <button onclick="toggleCamera()" class="mr-2 bg-slate-900 dark:bg-blue-600 text-white p-5 rounded-[2.2rem] shadow-xl hover:scale-105 active:scale-95 transition-all">
          <i data-lucide="scan-line" class="w-7 h-7"></i>
        </button>
      </div>
    </section>

    <div id="result-container" class="hidden space-y-4 fade-in">
      <div class="bg-white dark:bg-neutral-900 rounded-[2.5rem] shadow-xl border border-slate-100 dark:border-neutral-800 overflow-hidden">
        
        <div class="p-6 bg-gradient-to-br from-blue-600 to-indigo-700 text-white">
          <div class="flex justify-between items-start">
            <span class="bg-white/20 px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest">Master Item</span>
            <button id="main-share-btn" class="p-2 bg-white/10 rounded-full hover:bg-white/20 transition-all">
              <i data-lucide="share-2" class="w-5 h-5"></i>
            </button>
          </div>
          <h2 id="result-title" class="text-3xl font-black mt-3 leading-tight tracking-tighter"></h2>
          <div class="flex items-center gap-4 mt-4">
            <div class="bg-white/10 px-4 py-2 rounded-2xl">
                <p class="text-[9px] uppercase font-bold opacity-70">Main Barcode</p>
                <p id="result-barcode" class="font-mono font-bold"></p>
            </div>
            <div class="bg-white/10 px-4 py-2 rounded-2xl">
                <p class="text-[9px] uppercase font-bold opacity-70">Base Price</p>
                <p id="result-price" class="text-xl font-black"></p>
            </div>
          </div>
        </div>

        <div class="p-6 space-y-4">
            <h3 class="text-[10px] font-black text-slate-400 dark:text-neutral-500 uppercase tracking-[0.2em]">Packing Variations (CF)</h3>
            <div id="variation-list" class="space-y-3">
                </div>
        </div>

        <div id="full-details" class="px-6 pb-6 pt-2 divide-y divide-slate-50 dark:divide-neutral-800 hidden">
            </div>
        
        <button onclick="toggleDetails()" class="w-full py-4 text-[10px] font-black uppercase text-slate-400 border-t border-slate-50 dark:border-neutral-800 hover:bg-slate-50 dark:hover:bg-neutral-800 transition-all">
            Show All Technical Data
        </button>
      </div>
    </div>

    <div id="list-container" class="hidden fade-in">
      <div class="bg-white dark:bg-neutral-900 rounded-[2.5rem] shadow-sm border border-slate-100 dark:border-neutral-800 overflow-hidden">
        <div id="match-list" class="divide-y divide-slate-50 dark:divide-neutral-800"></div>
      </div>
    </div>

    <section id="history-section" class="px-2">
        <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Recent Searches</h3>
        <div id="history-list" class="flex flex-wrap gap-2">
            </div>
    </section>

    <div id="no-result" class="hidden fade-in text-center py-16">
        <div class="bg-slate-100 dark:bg-neutral-900 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-4 shadow-inner">
          <i data-lucide="search-x" class="text-slate-300 w-10 h-10"></i>
        </div>
        <h3 class="font-black text-slate-800 dark:text-neutral-300">No Product Found</h3>
        <p class="text-sm text-slate-400 mt-1">Check the barcode or spelling</p>
    </div>

  </div>

  <script>
    /**
     * GLOBAL APP STATE
     */
    let inventory = [];
    let headers = [];
    let html5QrCode = null;
    let searchHistory = JSON.parse(localStorage.getItem('kmart_history') || '[]');

    lucide.createIcons();

    window.onload = () => {
        fetchData();
        renderHistory();
        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("service-worker.js").catch(e => console.log(e));
        }
    };

    /**
     * DATA CORE
     */
    async function fetchData() {
      const sheetId = document.getElementById("sheet-id").value;
      const gid = document.getElementById("gid-id").value;
      const statusText = document.getElementById("status-text");
      const statusDot = document.getElementById("status-dot");

      try {
        const response = await fetch(`https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`);
        if (!response.ok) throw new Error();
        const rawText = await response.text();
        inventory = parseCSV(rawText);
        headers = Object.keys(inventory[0]);

        statusText.innerText = `Online â€¢ ${inventory.length} Items`;
        statusDot.className = "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_#22c55e]";
        
        document.getElementById("last-update-time").innerText = "Sync: " + new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
      } catch (err) {
        statusText.innerText = "Offline";
        statusDot.className = "w-2 h-2 rounded-full bg-red-500";
      }
    }

    /**
     * SEARCH ENGINE
     */
    function handleSearch() {
      const query = document.getElementById("smart-search-input").value.trim().toLowerCase();
      
      const resCon = document.getElementById("result-container");
      const listCon = document.getElementById("list-container");
      const noRes = document.getElementById("no-result");

      resCon.classList.add("hidden");
      listCon.classList.add("hidden");
      noRes.classList.add("hidden");

      if (query.length < 2) return;

      let results = [];
      
      // 1. Try Barcode Match (Exact)
      results = inventory.filter(row => String(Object.values(row)[0]).toLowerCase() === query);

      // 2. Try Name Match (Tokens)
      if (results.length === 0) {
        const tokens = query.split(/\s+/).filter(t => t);
        results = inventory.filter(row => {
          const name = String(Object.values(row)[1]).toLowerCase();
          return tokens.every(t => name.includes(t));
        });
      }

      if (results.length === 0) {
        noRes.classList.remove("hidden");
      } else {
        processResults(results);
      }
    }

    /**
     * PROCESS & GROUPING LOGIC (The CF Logic)
     */
    function processResults(matches) {
        // Find the "Main" item (Try to find CF = 1 or use the first name-match)
        // We group by Name (Column index 1)
        const primaryName = Object.values(matches[0])[1];
        
        // Find all items with this exact name in the whole inventory
        const allVariations = inventory.filter(row => Object.values(row)[1] === primaryName);
        
        // Sort: CF 1 should be first
        allVariations.sort((a, b) => {
            const cfA = parseFloat(a['CF'] || a['cf'] || 0);
            const cfB = parseFloat(b['CF'] || b['cf'] || 0);
            return cfA === 1 ? -1 : (cfB === 1 ? 1 : cfA - cfB);
        });

        renderGroupedUI(allVariations);
        addToHistory(primaryName);
    }

    function renderGroupedUI(variations) {
        const main = variations[0];
        const resCon = document.getElementById("result-container");
        resCon.classList.remove("hidden");

        document.getElementById("result-title").innerText = Object.values(main)[1];
        document.getElementById("result-barcode").innerText = Object.values(main)[0];
        document.getElementById("result-price").innerText = "AED " + (main['Price'] || main['PRICE'] || main['mrp'] || '0.00');

        // Variations List
        const varList = document.getElementById("variation-list");
        varList.innerHTML = "";

        variations.forEach((v, idx) => {
            const cfVal = v['CF'] || v['cf'] || '1';
            const priceVal = v['Price'] || v['PRICE'] || v['mrp'] || '0.00';
            const barcodeVal = Object.values(v)[0];

            const item = document.createElement("div");
            item.className = `flex items-center justify-between p-4 rounded-3xl border ${idx === 0 ? 'bg-blue-50 border-blue-100 dark:bg-blue-900/20 dark:border-blue-800' : 'bg-slate-50 dark:bg-neutral-800/40 border-slate-100 dark:border-neutral-800'}`;
            
            item.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-white dark:bg-neutral-800 flex items-center justify-center font-black text-xs shadow-sm">
                        ${cfVal}
                    </div>
                    <div>
                        <p class="text-[10px] font-black text-slate-400 uppercase">Packing Unit</p>
                        <p class="text-xs font-mono font-bold text-slate-500">${barcodeVal}</p>
                    </div>
                </div>
                <div class="text-right flex items-center gap-3">
                    <div>
                        <p class="text-lg font-black dark:text-white">AED ${priceVal}</p>
                    </div>
                    <button onclick="shareItem('${Object.values(v)[1]}', '${barcodeVal}', '${priceVal}', '${cfVal}')" class="p-2 text-slate-400 hover:text-green-500 transition-colors">
                        <i data-lucide="share" class="w-4 h-4"></i>
                    </button>
                </div>
            `;
            varList.appendChild(item);
        });

        // Technical Details Injection
        const details = document.getElementById("full-details");
        details.innerHTML = "";
        headers.forEach(h => {
            details.innerHTML += `<div class="py-3 flex justify-between"><span class="text-[10px] font-bold text-slate-400 uppercase">${h}</span><span class="text-xs font-bold dark:text-white">${main[h]}</span></div>`;
        });

        lucide.createIcons();
    }

    /**
     * VOICE SEARCH
     */
    function startVoiceSearch() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) return alert("Voice search not supported on this browser.");
        
        const rec = new SpeechRecognition();
        rec.lang = 'en-US';
        const btn = document.getElementById("voice-btn");
        
        rec.onstart = () => { btn.classList.add("text-blue-500", "pulse-blue"); };
        rec.onresult = (e) => {
            const transcript = e.results[0][0].transcript;
            document.getElementById("smart-search-input").value = transcript;
            handleSearch();
        };
        rec.onend = () => { btn.classList.remove("text-blue-500", "pulse-blue"); };
        rec.start();
    }

    /**
     * CAMERA SYSTEM
     */
    function toggleCamera() {
      const con = document.getElementById("reader-container");
      if (!con.classList.contains("hidden")) stopCamera();
      else startCamera();
    }

    function startCamera() {
      document.getElementById("reader-container").classList.remove("hidden");
      html5QrCode = new Html5Qrcode("reader");
      html5QrCode.start({ facingMode: "environment" }, { fps: 25, qrbox: { width: 250, height: 120 } }, 
        (txt) => {
          document.getElementById("smart-search-input").value = txt;
          stopCamera();
          handleSearch();
          if (navigator.vibrate) navigator.vibrate(100);
        }, () => {});
    }

    function stopCamera() {
      if (html5QrCode) {
        html5QrCode.stop().then(() => { html5QrCode.clear(); html5QrCode = null; });
      }
      document.getElementById("reader-container").classList.add("hidden");
    }

    /**
     * UTILS
     */
    function toggleDetails() {
        document.getElementById("full-details").classList.toggle("hidden");
    }

    function shareItem(name, code, price, cf) {
        const text = `ðŸ›’ *K MART AL RAFFA*\n\n*Product:* ${name}\n*Barcode:* ${code}\n*Price:* AED ${price}\n*Packing (CF):* ${cf}\n\n_Checked via K-Mart Item Master_`;
        if (navigator.share) {
            navigator.share({ title: 'Product Info', text: text });
        } else {
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`);
        }
    }

    function addToHistory(name) {
        searchHistory = [name, ...searchHistory.filter(i => i !== name)].slice(0, 8);
        localStorage.setItem('kmart_history', JSON.stringify(searchHistory));
        renderHistory();
    }

    function renderHistory() {
        const container = document.getElementById("history-list");
        container.innerHTML = "";
        searchHistory.forEach(item => {
            const pill = document.createElement("button");
            pill.className = "px-4 py-2 bg-white dark:bg-neutral-900 border border-slate-100 dark:border-neutral-800 rounded-full text-xs font-bold text-slate-500 hover:border-blue-500 transition-all";
            pill.innerText = item;
            pill.onclick = () => {
                document.getElementById("smart-search-input").value = item;
                handleSearch();
            };
            container.appendChild(pill);
        });
    }

    function parseCSV(text) {
      const lines = text.split(/\r?\n/);
      if (lines.length < 2) return [];
      const head = splitCSVLine(lines[0]);
      return lines.slice(1).filter(l => l.trim()).map(line => {
        const vals = splitCSVLine(line);
        let obj = {};
        head.forEach((h, idx) => { obj[h.trim()] = vals[idx] ? vals[idx].trim() : ""; });
        return obj;
      });
    }

    function splitCSVLine(line) {
      const parts = []; let current = ""; let inside = false;
      for (let char of line) {
        if (char === '"') inside = !inside;
        else if (char === ',' && !inside) { parts.push(current); current = ""; }
        else current += char;
      }
      parts.push(current); return parts;
    }

    const darkModeQuery = window.matchMedia('(prefers-color-scheme: dark)');
    function setLogo(isDark) { document.getElementById('app-logo').src = isDark ? 'icon-dark-512.png' : 'icon-512.png'; }
    setLogo(darkModeQuery.matches);
    darkModeQuery.addEventListener('change', e => setLogo(e.matches));
  </script>
</body>
</html>
