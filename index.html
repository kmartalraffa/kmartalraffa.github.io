<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>K MART PRO MASTER</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');
    
    body { 
      font-family: 'Inter', sans-serif; 
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }

    /* Light Mode (Forced visibility) */
    @media (prefers-color-scheme: light) {
      body { background-color: #f1f5f9; color: #0f172a; }
      .glass-card { background: #ffffff; border: 1px solid #cbd5e1; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
      .text-dim { color: #64748b; }
      .search-box { background: #ffffff; border: 2px solid #94a3b8; }
      .modal-content { background: #ffffff; }
    }

    /* Dark Mode */
    @media (prefers-color-scheme: dark) {
      body { background-color: #000000; color: #f8fafc; }
      .glass-card { background: #111111; border: 1px solid #1e293b; }
      .text-dim { color: #94a3b8; }
      .search-box { background: #111111; border: 1px solid #334155; }
      .modal-content { background: #0a0a0a; }
    }

    #item-modal {
      display: none; position: fixed; inset: 0; z-index: 1000;
      background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);
      align-items: flex-end; justify-content: center;
    }
    #item-modal.active { display: flex; }

    .no-scrollbar::-webkit-scrollbar { display: none; }
  </style>
</head>
<body class="min-h-screen pb-20">

  <div class="max-w-xl mx-auto px-4 py-6 space-y-6">
    <header class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="p-1 bg-white rounded-xl border-2 border-slate-200">
          <img src="icon-192.jpeg" class="w-10 h-10 rounded-lg object-cover">
        </div>
        <div>
          <h1 class="text-xl font-black tracking-tighter uppercase leading-none">K Mart</h1>
          <p class="text-[10px] font-bold text-dim uppercase tracking-widest mt-1">Al Raffa • Pro Master</p>
        </div>
      </div>
      <div class="flex items-center gap-2 px-4 py-2 rounded-full glass-card">
        <div id="sync-dot" class="w-2 h-2 rounded-full bg-orange-500 animate-pulse"></div>
        <span id="sync-text" class="text-[9px] font-black uppercase">Syncing...</span>
      </div>
    </header>

    <div class="search-box p-2 flex items-center rounded-[2rem] shadow-2xl">
      <button onclick="engine.startVoice()" class="p-4 text-slate-400 hover:text-blue-500"><i data-lucide="mic"></i></button>
      <input id="main-input" type="text" placeholder="Scan Barcode or Name..." 
        class="w-full bg-transparent py-4 px-2 text-lg font-bold outline-none placeholder:text-slate-400"
        oninput="engine.debounce()">
      <button onclick="ui.toggleScanner()" class="bg-slate-900 dark:bg-slate-100 text-white dark:text-black p-4 rounded-2xl shadow-xl active:scale-90 transition-all">
        <i data-lucide="camera"></i>
      </button>
    </div>

    <div id="scanner-wrap" class="hidden relative h-48 bg-black rounded-[2rem] overflow-hidden border-2 border-slate-800">
      <div id="reader" class="w-full"></div>
      <button onclick="ui.stopScanner()" class="absolute top-3 right-3 bg-red-500 text-white p-2 rounded-full z-10"><i data-lucide="x" class="w-4 h-4"></i></button>
    </div>

    <main id="results-container" class="hidden space-y-6">
      <div class="glass-card p-6 rounded-[2.5rem]">
        <h2 id="res-name" class="text-2xl font-black tracking-tight leading-tight mb-6"></h2>
        <div class="grid grid-cols-2 gap-3">
          <div class="bg-slate-100/50 dark:bg-slate-800/40 p-4 rounded-2xl border border-slate-200/50 dark:border-slate-700/50">
            <p class="text-[9px] font-black text-dim uppercase mb-1">Base Cost (CF1)</p>
            <p id="res-cost" class="font-bold text-lg text-blue-600 dark:text-blue-400"></p>
          </div>
          <div class="bg-slate-900 dark:bg-white text-white dark:text-black p-4 rounded-2xl">
            <p class="text-[9px] font-black opacity-50 uppercase mb-1">Base MRP</p>
            <p id="res-mrp" class="text-xl font-black"></p>
          </div>
        </div>
      </div>

      <div class="space-y-3">
        <p class="text-[10px] font-black text-dim uppercase tracking-[0.3em] px-4">Calculated Stock per Packing</p>
        <div id="variant-list" class="space-y-3"></div>
      </div>
    </main>

    <div id="empty-state" class="hidden text-center py-20 opacity-20"><i data-lucide="search-x" class="w-12 h-12 mx-auto"></i></div>
  </div>

  <div id="item-modal">
    <div class="modal-content w-full max-w-lg rounded-t-[3rem] p-4 shadow-2xl">
      <div id="capture-zone" class="p-8 bg-white dark:bg-neutral-900 rounded-[2rem]">
        <div class="flex justify-between items-start mb-6">
          <h4 class="text-blue-600 font-black text-[10px] tracking-widest uppercase">K MART AL RAFFA</h4>
          <span id="pop-cf" class="text-[10px] font-black bg-slate-100 dark:bg-slate-800 px-3 py-1 rounded-lg"></span>
        </div>
        <h3 id="pop-name" class="text-2xl font-black mb-6 leading-tight dark:text-white text-slate-900"></h3>
        <div id="pop-grid" class="space-y-2 border-t pt-4 border-slate-100 dark:border-slate-800"></div>
      </div>
      <div class="p-6 flex gap-3">
        <button onclick="ui.closeModal()" class="p-4 glass-card rounded-2xl"><i data-lucide="x"></i></button>
        <button onclick="engine.shareImage()" id="share-btn" class="flex-grow py-4 bg-black dark:bg-white text-white dark:text-black rounded-2xl font-black text-xs uppercase tracking-widest flex items-center justify-center gap-2">
          <i data-lucide="share-2" class="w-4 h-4"></i> Share Card
        </button>
      </div>
    </div>
  </div>

  <script>
    let _DB = [], _ACTIVE_SET = [], _SCANNER = null, _TIMER = null;

    async function sync() {
      const sid = "1eEFtb7wxOOLw-TFTf_NvSFq1VQy1qYlMoVmiZkFgUys";
      const gid = "710656272";
      try {
        const r = await fetch(`https://docs.google.com/spreadsheets/d/${sid}/export?format=csv&gid=${gid}`);
        const t = await r.text();
        _DB = parseCSV(t);
        document.getElementById('sync-text').innerText = `Online • ${_DB.length}`;
        document.getElementById('sync-dot').classList.replace('bg-orange-500', 'bg-green-500');
      } catch (e) { document.getElementById('sync-text').innerText = "Offline"; }
    }

    const engine = {
      debounce: () => { clearTimeout(_TIMER); _TIMER = setTimeout(() => engine.search(), 300); },
      
      search: () => {
        const q = document.getElementById('main-input').value.trim().toLowerCase();
        if (q.length < 2) return;
        
        let matches = _DB.filter(i => String(i.ItemBarCode).toLowerCase() === q);
        if (matches.length === 0) matches = _DB.filter(i => String(i.ItemName).toLowerCase().includes(q));

        if (matches.length > 0) {
          _ACTIVE_SET = _DB.filter(i => i.ItemName === matches[0].ItemName);
          _ACTIVE_SET.sort((a,b) => (a.CF || 1) - (b.CF || 1));
          engine.render();
          document.getElementById('results-container').classList.remove('hidden');
        }
      },

      render: () => {
        const cf1Item = _ACTIVE_SET.find(i => i.CF == 1) || _ACTIVE_SET[0];
        const baseStock = parseFloat(cf1Item.LiveStock) || 0;

        document.getElementById('res-name').innerText = cf1Item.ItemName;
        document.getElementById('res-cost').innerText = `AED ${cf1Item.CostPrice}`;
        document.getElementById('res-mrp').innerText = `AED ${cf1Item.MRP}`;

        const list = document.getElementById('variant-list');
        list.innerHTML = "";

        _ACTIVE_SET.forEach((item, idx) => {
          const currentCF = parseFloat(item.CF) || 1;
          // Stock Logic: Base Stock / Current CF
          const calculatedStock = Math.floor(baseStock / currentCF);
          
          const card = document.createElement('div');
          card.className = "glass-card p-5 rounded-[1.5rem] flex items-center justify-between cursor-pointer active:scale-95 transition-all";
          card.onclick = () => ui.openModal(idx, calculatedStock);
          card.innerHTML = `
            <div class="flex items-center gap-4">
              <div class="w-10 h-10 rounded-xl bg-slate-100 dark:bg-slate-800 flex flex-col items-center justify-center border dark:border-slate-700">
                <span class="text-[7px] font-black opacity-40 uppercase">CF</span>
                <span class="text-xs font-black text-blue-500">${currentCF}</span>
              </div>
              <div>
                <p class="font-mono font-bold text-[10px] text-dim">${item.ItemBarCode}</p>
                <p class="text-[9px] font-black uppercase text-blue-500/60 mt-0.5">Price: AED ${item.MRP}</p>
              </div>
            </div>
            <div class="text-right">
              <p class="text-lg font-black leading-none mb-1">${calculatedStock}</p>
              <p class="text-[8px] font-bold text-dim uppercase">Live Units</p>
            </div>
          `;
          list.appendChild(card);
        });
        lucide.createIcons();
      },

      shareImage: async () => {
        const btn = document.getElementById('share-btn');
        btn.innerText = "Processing...";
        const area = document.getElementById('capture-zone');
        const canvas = await html2canvas(area, { scale: 2, useCORS: true });
        canvas.toBlob(blob => {
          const file = new File([blob], 'kmart.png', { type: 'image/png' });
          if (navigator.share) navigator.share({ files: [file] });
          btn.innerHTML = `<i data-lucide="share-2" class="w-4 h-4"></i> Share Card`;
          lucide.createIcons();
        });
      },

      startVoice: () => {
        const S = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!S) return;
        const r = new S();
        r.onresult = (e) => { document.getElementById('main-input').value = e.results[0][0].transcript; engine.search(); };
        r.start();
      }
    };

    const ui = {
      toggleScanner: () => {
        const w = document.getElementById('scanner-wrap');
        w.classList.toggle('hidden');
        if (!w.classList.contains('hidden')) {
          _SCANNER = new Html5Qrcode("reader");
          _SCANNER.start({ facingMode: "environment" }, { fps: 20, qrbox: 250 }, (t) => {
            document.getElementById('main-input').value = t; ui.stopScanner(); engine.search();
          });
        } else ui.stopScanner();
      },
      stopScanner: () => { if(_SCANNER) _SCANNER.stop().then(() => { _SCANNER.clear(); document.getElementById('scanner-wrap').classList.add('hidden'); }); },
      openModal: (idx, calcStock) => {
        const item = _ACTIVE_SET[idx];
        document.getElementById('pop-name').innerText = item.ItemName;
        document.getElementById('pop-cf').innerText = `PACKING CF: ${item.CF}`;
        const grid = document.getElementById('pop-grid');
        grid.innerHTML = `
          <div class="flex justify-between py-2 border-b border-slate-50 dark:border-slate-800 text-[10px] font-bold uppercase"><span class="text-dim">Barcode</span><span class="dark:text-white">${item.ItemBarCode}</span></div>
          <div class="flex justify-between py-2 border-b border-slate-50 dark:border-slate-800 text-[10px] font-bold uppercase"><span class="text-dim">Cost Price</span><span class="text-blue-500">${item.CostPrice}</span></div>
          <div class="flex justify-between py-2 border-b border-slate-50 dark:border-slate-800 text-[10px] font-bold uppercase"><span class="text-dim">MRP Rate</span><span class="dark:text-white">${item.MRP}</span></div>
          <div class="flex justify-between py-2 border-b border-slate-50 dark:border-slate-800 text-[10px] font-bold uppercase"><span class="text-dim">Live Stock</span><span class="text-green-500">${calcStock}</span></div>
        `;
        document.getElementById('item-modal').classList.add('active');
      },
      closeModal: () => document.getElementById('item-modal').classList.remove('active')
    };

    function parseCSV(t) {
      const lines = t.split(/\r?\n/);
      const h = lines[0].split(',').map(s => s.trim());
      return lines.slice(1).filter(l => l).map(line => {
        const v = line.split(',');
        let o = {}; h.forEach((head, i) => o[head] = v[i]?.trim());
        return o;
      });
    }

    sync();
    lucide.createIcons();
  </script>
</body>
</html>
