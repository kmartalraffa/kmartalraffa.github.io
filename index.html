<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>K MART AL RAFFA - Item Master</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f8fafc">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000000">
  <link rel="apple-touch-icon" href="icon-192.jpeg">
  <link rel="icon" type="image/png" href="icon-512.png">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

  <style>
    body { 
      -webkit-user-select: none; 
      user-select: none; 
      -webkit-tap-highlight-color: transparent; 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    /* Modern Scrollbar */
    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

    /* Glassmorphism Styles */
    .modern-card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(226, 232, 240, 0.8);
    }

    @media (prefers-color-scheme: dark) {
      .modern-card {
        background: rgba(18, 18, 18, 0.9);
        border: 1px solid rgba(38, 38, 38, 1);
      }
    }

    /* Scanner Viewport */
    #reader-container {
      position: relative; width: 100%; height: 230px; overflow: hidden;
      border-radius: 2.5rem; background: #000;
      box-shadow: 0 20px 50px rgba(0,0,0,0.2);
    }
    
    #reader video { width: 100% !important; height: 230px !important; object-fit: cover !important; }

    .scan-overlay {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      width: 80%; height: 110px; border: 2px solid rgba(255, 255, 255, 0.4);
      box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
      border-radius: 20px; z-index: 10;
    }

    .scan-line {
      width: 100%; height: 2px; background: #3b82f6;
      position: absolute; top: 0; box-shadow: 0 0 15px #3b82f6;
      animation: scanMove 2s infinite linear;
    }

    @keyframes scanMove { 0% { top: 0; } 50% { top: 100%; } 100% { top: 0; } }
    .fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>

<body class="bg-[#f8fafc] dark:bg-black min-h-screen p-4 md:p-8 pb-24 transition-colors duration-500">

  <div class="max-w-md mx-auto space-y-6">

    <header class="flex items-center gap-4 px-2">
      <div class="relative">
        <div class="w-14 h-14 rounded-2xl overflow-hidden border-2 border-white dark:border-neutral-800 shadow-xl">
          <img src="icon-192.jpeg" id="app-logo" class="w-full h-full object-cover" alt="K Mart">
        </div>
        <div class="absolute -bottom-1 -right-1 w-4 h-4 bg-green-500 border-2 border-[#f8fafc] dark:border-black rounded-full"></div>
      </div>
      <div class="flex-grow">
        <h1 class="text-2xl font-black tracking-tight text-slate-900 dark:text-white">K MART</h1>
        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em]">Al Raffa • Item Master</p>
      </div>
      <div id="last-update-container" class="hidden text-right">
        <p class="text-[8px] font-black text-slate-300 dark:text-neutral-600 uppercase">Last Sync</p>
        <p id="last-update-time" class="text-[10px] font-bold text-slate-500 dark:text-neutral-400 font-mono"></p>
      </div>
    </header>

    <div id="settings-panel" class="hidden">
      <input id="sheet-id" type="text" value="1eEFtb7wxOOLw-TFTf_NvSFq1VQy1qYlMoVmiZkFgUys" />
      <input id="gid-id" type="text" value="710656272" />
    </div>

    <section id="reader-container" class="hidden fade-in">
      <div id="reader"></div>
      <div class="scan-overlay"><div class="scan-line"></div></div>
      <button onclick="stopCamera()" class="absolute top-4 right-4 bg-black/50 backdrop-blur-md p-2.5 rounded-full text-white hover:bg-red-500 transition-colors z-20">
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>
    </section>

    <div id="status-pill" class="mx-2 flex items-center gap-2 bg-white dark:bg-neutral-900 px-4 py-2 rounded-2xl border border-slate-100 dark:border-neutral-800 shadow-sm transition-all duration-500">
        <span id="status-dot" class="w-2 h-2 rounded-full bg-orange-500 animate-pulse"></span>
        <span id="status-text" class="text-xs font-bold text-slate-600 dark:text-neutral-400">Connecting to database...</span>
    </div>

    <main class="modern-card p-2 rounded-[2.5rem] shadow-2xl shadow-slate-200/50 dark:shadow-none transition-all">
      <div class="flex flex-col">
        <div class="relative flex items-center">
          <div class="pl-6 text-slate-400"><i data-lucide="scan-barcode" class="w-6 h-6"></i></div>
          <input id="id-search-input" type="text" inputmode="numeric" placeholder="Scan or Type Barcode"
            class="w-full pl-4 pr-16 py-6 bg-transparent text-xl font-bold dark:text-white placeholder:text-slate-300 dark:placeholder:neutral-700 focus:outline-none"
            oninput="handleSearch()" />
          <button id="camera-toggle-btn" onclick="toggleCamera()" class="absolute right-3 bg-slate-900 dark:bg-blue-600 text-white p-4 rounded-[1.5rem] shadow-lg active:scale-90 transition-all">
            <i data-lucide="camera" class="w-6 h-6"></i>
          </button>
        </div>

        <div class="flex items-center px-6">
          <div class="h-[1px] bg-slate-100 dark:bg-neutral-800 w-full"></div>
          <span class="px-3 text-[10px] font-black text-slate-200 dark:text-neutral-800 tracking-widest uppercase">OR</span>
          <div class="h-[1px] bg-slate-100 dark:bg-neutral-800 w-full"></div>
        </div>

        <div class="relative flex items-center">
          <div class="pl-6 text-slate-400"><i data-lucide="search" class="w-6 h-6"></i></div>
          <input id="name-search-input" type="text" placeholder="Search by product name..."
            class="w-full pl-4 pr-6 py-6 bg-transparent text-lg font-medium dark:text-white placeholder:text-slate-300 dark:placeholder:neutral-700 focus:outline-none"
            oninput="handleSearch()" />
        </div>
      </div>
    </main>

    <div id="result-container" class="hidden space-y-3 fade-in">
      <div class="bg-white dark:bg-neutral-900 rounded-[2.5rem] shadow-xl border border-slate-100 dark:border-neutral-800 overflow-hidden">
        <div class="bg-blue-600 p-6 flex items-center gap-4">
          <div class="bg-white/20 p-3 rounded-2xl text-white"><i data-lucide="package" class="w-6 h-6"></i></div>
          <h2 id="result-title" class="text-xl font-black text-white leading-tight"></h2>
        </div>
        <div id="result-details" class="p-6 divide-y divide-slate-50 dark:divide-neutral-800"></div>
      </div>
    </div>

    <div id="list-container" class="hidden fade-in">
      <div class="bg-white dark:bg-neutral-900 rounded-[2.5rem] shadow-sm border border-slate-100 dark:border-neutral-800 overflow-hidden">
        <div id="match-list" class="divide-y divide-slate-50 dark:divide-neutral-800"></div>
      </div>
    </div>

    <div id="no-result" class="hidden fade-in text-center py-12">
        <div class="bg-slate-50 dark:bg-neutral-900 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
          <i data-lucide="alert-circle" class="text-slate-300 w-10 h-10"></i>
        </div>
        <h3 class="font-bold text-slate-800 dark:text-neutral-300">No Product Found</h3>
        <p class="text-xs text-slate-400 mt-1">Try a different barcode or name</p>
    </div>

    <footer class="pt-4 opacity-50">
      <img src="banner.png" class="w-full rounded-[2.5rem] grayscale dark:invert" alt="K Mart Footer">
    </footer>

  </div>

  <script>
    let inventory = [];
    let headers = [];
    let html5QrCode = null;

    lucide.createIcons();

    window.onload = function() {
      fetchData();
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("service-worker.js").catch(err => console.log(err));
      }
    };

    async function fetchData() {
      const sheetId = document.getElementById("sheet-id").value;
      const gid = document.getElementById("gid-id").value;
      const statusText = document.getElementById("status-text");
      const statusDot = document.getElementById("status-dot");
      const statusPill = document.getElementById("status-pill");

      try {
        const response = await fetch(`https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`);
        if (!response.ok) throw new Error("Fetch Failed");
        const rawText = await response.text();
        inventory = parseCSV(rawText);
        headers = Object.keys(inventory[0]);

        statusText.innerText = `Online • ${inventory.length.toLocaleString()} Items`;
        statusDot.className = "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e]";
        statusPill.classList.add("border-green-100", "dark:border-green-900/30");
        
        const now = new Date();
        document.getElementById("last-update-time").innerText = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        document.getElementById("last-update-container").classList.remove("hidden");
      } catch (err) {
        statusText.innerText = "Connection Error";
        statusDot.className = "w-2 h-2 rounded-full bg-red-500";
      }
    }

    function handleSearch() {
      const idTerm = document.getElementById("id-search-input").value.trim().toLowerCase();
      const nameTerm = document.getElementById("name-search-input").value.trim().toLowerCase();
      
      const resCon = document.getElementById("result-container");
      const listCon = document.getElementById("list-container");
      const noRes = document.getElementById("no-result");

      resCon.classList.add("hidden");
      listCon.classList.add("hidden");
      noRes.classList.add("hidden");

      if (!idTerm && !nameTerm) return;

      let results = [];
      if (idTerm) {
        results = inventory.filter(row => String(Object.values(row)[0]).toLowerCase() === idTerm);
      } else if (nameTerm && nameTerm.length > 2) {
        const tokens = nameTerm.split(/\s+/).filter(t => t);
        results = inventory.filter(row => {
          const itemName = String(Object.values(row)[1]).toLowerCase();
          return tokens.every(token => itemName.includes(token));
        });
      }

      if (results.length === 1) renderSingleItem(results[0]);
      else if (results.length > 1) renderItemList(results);
      else if (idTerm || (nameTerm && nameTerm.length > 2)) noRes.classList.remove("hidden");
    }

    function renderSingleItem(match) {
      document.getElementById("result-container").classList.remove("hidden");
      document.getElementById("result-title").innerText = Object.values(match)[1];
      let detailsHtml = "";
      headers.forEach((header, index) => {
        const val = match[header];
        let displayVal = val || "-";
        let style = "text-slate-700 dark:text-neutral-300 font-bold";
        
        if (index === 0) displayVal = `<span class="bg-slate-100 dark:bg-neutral-800 px-3 py-1 rounded-lg font-mono text-sm">${val}</span>`;
        if (header.toLowerCase().includes("price") || header.toLowerCase().includes("mrp")) {
          displayVal = `<span class="text-2xl font-black text-slate-900 dark:text-white tracking-tight">${val}</span>`;
        }

        detailsHtml += `<div class="py-4 flex justify-between items-start gap-4">
          <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest pt-1.5">${header}</span>
          <div class="text-right ${style}">${displayVal}</div>
        </div>`;
      });
      document.getElementById("result-details").innerHTML = detailsHtml;
      lucide.createIcons();
    }

    function renderItemList(matches) {
      document.getElementById("list-container").classList.remove("hidden");
      const listWrap = document.getElementById("match-list");
      listWrap.innerHTML = "";
      matches.forEach(match => {
        const row = document.createElement("div");
        row.className = "p-5 flex justify-between items-center active:bg-slate-50 dark:active:bg-neutral-800 transition-colors";
        row.innerHTML = `<div><p class="font-bold text-slate-800 dark:text-neutral-200">${Object.values(match)[1]}</p>
                         <p class="text-[10px] font-mono text-slate-400">${Object.values(match)[0]}</p></div>
                         <i data-lucide="chevron-right" class="w-5 h-5 text-slate-300"></i>`;
        row.onclick = () => renderSingleItem(match);
        listWrap.appendChild(row);
      });
      lucide.createIcons();
    }

    function toggleCamera() {
      const container = document.getElementById("reader-container");
      if (!container.classList.contains("hidden")) stopCamera();
      else startCamera();
    }

    function startCamera() {
      document.getElementById("reader-container").classList.remove("hidden");
      html5QrCode = new Html5Qrcode("reader");
      html5QrCode.start({ facingMode: "environment" }, { fps: 25, qrbox: { width: 250, height: 120 } }, 
        (txt) => {
          document.getElementById("id-search-input").value = txt;
          stopCamera();
          handleSearch();
          if (navigator.vibrate) navigator.vibrate(100);
        }, () => {});
    }

    function stopCamera() {
      if (html5QrCode) {
        html5QrCode.stop().then(() => { html5QrCode.clear(); html5QrCode = null; });
      }
      document.getElementById("reader-container").classList.add("hidden");
    }

    function parseCSV(text) {
      const lines = text.split(/\r?\n/);
      if (lines.length < 2) return [];
      const headArray = splitCSVLine(lines[0]);
      const dataStore = [];
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        const valArray = splitCSVLine(line);
        const itemObj = {};
        headArray.forEach((h, idx) => {
          itemObj[h.trim()] = valArray[idx] ? valArray[idx].trim() : "";
        });
        dataStore.push(itemObj);
      }
      return dataStore;
    }

    function splitCSVLine(line) {
      const parts = [];
      let current = "";
      let insideQuotes = false;
      for (let char of line) {
        if (char === '"') insideQuotes = !insideQuotes;
        else if (char === ',' && !insideQuotes) { parts.push(current); current = ""; }
        else current += char;
      }
      parts.push(current);
      return parts;
    }

    // Theme Logo Toggle
    const darkModeQuery = window.matchMedia('(prefers-color-scheme: dark)');
    function setLogo(isDark) { document.getElementById('app-logo').src = isDark ? 'icon-dark-512.png' : 'icon-512.png'; }
    setLogo(darkModeQuery.matches);
    darkModeQuery.addEventListener('change', e => setLogo(e.matches));

  </script>
</body>
</html>
